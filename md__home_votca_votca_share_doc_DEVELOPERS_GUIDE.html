<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>votca: Developer and Contributor Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">votca
   &#160;<span id="projectnumber">1.7-dev</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Developer and Contributor Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The page is designed to give new developers general guidelines for implementing code consistent with the VOTCA and cpp style and standard.</p>
<ul>
<li><a href="#reporting-bugs">Reporting Bugs</a></li>
<li><a href="#cpp-resources">CPP Resoures</a></li>
<li><a href="#cpp-tips">CPP Tips</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#failed-travis-builds">Failed Travis Builds</a></li>
<li><a href="#cpp-codeing-style-guide">CPP Codeing Style Guide</a></li>
<li><a href="#cpp-comment-guide">CPP Comment Guide</a></li>
<li><a href="#updating-git-submodules">Updating Git Submodules</a></li>
<li><a href="#merging-with-stable">Merging With Stable</a></li>
<li><a href="#failed-release-builds">Failed Release Builds</a></li>
<li><a href="#gitlab-server">Setting Up A GitLab Runner Server</a></li>
<li><a href="#units-in-votca">Units in VOTCA</a></li>
<li><a href="#indexing-in-votca">Indexing in VOTCA</a></li>
</ul>
<h2>Reporting Bugs</h2>
<p>To report a bug please create an issue on the appropriate github repo. Please be sure to provide as much information as possible such as:</p>
<ul>
<li>The error messages</li>
<li>The operating system</li>
<li>What compiler was used</li>
<li>What dependencies were installed</li>
<li>The calculation that was being run</li>
</ul>
<p>Issues can be directed created on the appropriate github repo:</p>
<ul>
<li><a href="https://github.com/votca/tools/issues">tools</a></li>
<li><a href="https://github.com/votca/csg/issues">csg</a></li>
<li><a href="https://github.com/votca/csgapps/issues">csgapps</a></li>
<li><a href="https://github.com/votca/csg-manual/issues">csg-manual</a></li>
<li><a href="https://github.com/votca/csg-tutorials/issues">csg-tutorials</a></li>
<li><a href="https://github.com/votca/xtp/issues">xtp</a></li>
<li><a href="https://github.com/votca/votca/issues">votca</a></li>
</ul>
<h2>Formatting code</h2>
<p>VOTCA uses <code>clang-format</code> to format the code, code that is not properly formatted is automatically rejected. The style files can be found in each repo. If you have a version <code>&gt;7.1</code> of <code>clang-format</code> you can just run <code>make format</code> and your code is formatted. For an even more automated version, see <a href="#votca-dev-tools">VOTCA dev-tools</a></p>
<h2>VOTCA dev-tools</h2>
<p>Running clang-format on every commit can be a drag, as can changing the copyright in every header. Building artifacts locally from a Gitlab run is also mutliple steps. Fortunately you will find small scripts in the <a href="https://github.com/votca/dev-tools">dev-tools repo</a>, which can automate this.</p>
<h2>CPP Resources</h2>
<p>A good starting point is to take a look at the cpp standard. Though the code has not always consistently followed the cpp standard we now make an effort to really enforce it and follow best practices.</p>
<ul>
<li><a href="https://www.gitbook.com/book/lefticus/cpp-best-practices/details">Best Practices1</a></li>
<li><a href="https://google.github.io/styleguide/cppguide.html">Best Practices2</a></li>
</ul>
<h2>CPP Tips</h2>
<p>Here are a few general tips that should be followed:</p>
<h3>Files</h3>
<ul>
<li>each class goes into a separate file</li>
<li>filename is name of class in lowercase</li>
</ul>
<h3>Includes</h3>
<ul>
<li>When including a header file from within the same repo that you are working use the relative includes. This consists of using quotation marks i.e.</li>
</ul>
<pre class="fragment">  #include "molecule.h"
</pre><ul>
<li>When including from another repository, for instance you are working in the csg repostory and want to include a file from the tools repo use the anglular brackets i.e.</li>
</ul>
<pre class="fragment">  #include &lt;votca/tools/table.h&gt;
</pre><h3>Header Files</h3>
<ul>
<li>One class, one header.</li>
<li>When creating header guards use the following form, where "VOTCA-REPO-NAME" is replaced by whichever repo the header is in tools/csg/xtp, and where "CLASS-NAME" is replaced by the name of the class described in the header file:</li>
</ul>
<pre class="fragment">  #ifndef VOTCA_VOTCA-REPO-NAME_CLASS-NAME_H
  #define VOTCA_VOTCA-REPO-NAME_CLASS-NAME_H
  :
  Code
  :
  #endif // VOTCA_VOTCA-REPO-NAME_CLASS-NAME_H
</pre><ul>
<li>Never use the "using namespace" in a header file.</li>
<li>Avoid using includes in header files. If possible forward declare a class instead.</li>
</ul>
<h3>Braces</h3>
<ul>
<li>in functions/classes, the { is in the next line</li>
<li>for for loops, if, ..., the { is n the same line as if,for</li>
</ul>
<h3>Auto</h3>
<ul>
<li>avoid using auto unless the type is very long, the reason being auto obscures the underlying type and can make it difficult to discern what a variable is meant to be used for</li>
</ul>
<h3>Classes</h3>
<ul>
<li>normally begin in upper case</li>
<li>order in class definition:<ul>
<li>first <code>public</code> all functions</li>
<li>then <code>private</code>/<code>protected</code> all member variables</li>
<li>then <code>private</code>/<code>protected</code> member functions</li>
<li>no rule where to define a <code>public typedef</code> in the class</li>
</ul>
</li>
<li>all member variables are <code>private</code>/<code>public</code></li>
<li>maximum one-line-function implementation in class declaration, everything else moves to separate file or inline at end of header.</li>
</ul>
<h3>Naming in Classes</h3>
<ul>
<li>all member variables are in lower case and end with <code>_</code></li>
<li>all functions start with upper case, no <code>_</code> in names</li>
<li>exception: <code>get</code>/<code>set</code> functions</li>
<li>for consistency all Ids should start at 0 not 1</li>
</ul>
<h3>get/set Functions</h3>
<ul>
<li>get/set functions start with a lowercase set/get (these are only functions which directly set/get a private member variable)</li>
<li>get must return a constant reference and keep the <code>class const</code>: <code>const int &amp;getId() const;</code></li>
<li>set only sets the member, e.g. <code>void setId(const int &amp;id) { _id = id; }</code></li>
</ul>
<h3>Functions</h3>
<ul>
<li>Make functions short.</li>
<li>Functions should not have more than one use. So use boolean arguments sparingly.</li>
</ul>
<h3>Pointers</h3>
<ul>
<li>In general, use pointers sparringly. Most objects are small and a copy does not change performance. Use references as well</li>
<li>If your pointer owns an object (i.e. it has to delete it later) use a <code>unique_ptr</code> to it, so you do not have to call <code>delete</code> on it yourself</li>
<li>If multiple objects own an object and the last object alive should delete it, use a <code>shared_ptr</code></li>
<li>If your object does not have ownership but just wants to visit, you can use a raw pointer, but if you can a reference is better.</li>
<li>If you ever have to explicitly call <code>delete</code>, you did something very wrong.</li>
</ul>
<h3>General</h3>
<ul>
<li>Do not comment out code, if you do not use it delete it.</li>
<li>Variables should have clear and explicit names.</li>
<li>Do not duplicate code.</li>
<li>Functions should have no more than 3 arguments. Otherwise create a class.</li>
<li>XYZ positions should be <code>Eigen::Vector3d</code> from the eigen library.</li>
<li>Readability is more important the elegant design.</li>
<li>Leave the code better than you found it.</li>
<li>Use pointers sparingly and especially try not to pass them around objects. Prefer references.</li>
<li>Do not write code, which you may use in the future. Only write code you will use now. Write code, you need later, later. This avoids cluttering the codebase with unused "at some point we will need this functions".</li>
</ul>
<h2>Testing</h2>
<h3>Unit Testing</h3>
<p>Each repository contains a src folder. Within the src folder exists a library folder: libtools, libcsg etc... and a tools folder. A tests folder should also exist in the src folder. If it does not you should create one.</p>
<p>For every new object and algorithm created there should exist a test. We use the Boost libraries testing framework. Good documentation can be found here:</p>
<ul>
<li><a href="https://www.ibm.com/developerworks/aix/library/au-ctools1_boost/">Boost link</a></li>
</ul>
<p>We will outline the general workflow here using the vec object in <a class="el" href="namespacevotca_1_1tools.html">votca::tools</a>. This object only has a header file it is in: tools/include/votca/tools/vec.h</p>
<p>Determine if a tests folder has already been created or not in /src if it has not take a look at what was done in the votca-tools repo.</p>
<ol type="1">
<li>Create a test file in <a href="https://github.com/votca/tools/tree/master/src/tests">tools/src/tests/</a>test_vec.cc must have the same name as what appears in the foreach in the CMakeLists.txt file. And place the following contents</li>
</ol>
<pre class="fragment">    #define BOOST_TEST_MAIN

    #define BOOST_TEST_MODULE vec_test
    #include &lt;boost/test/unit_test.hpp&gt;
    #include &lt;exception&gt;

    #include &lt;votca/tools/vec.h&gt;

    using namespace std;
    using namespace votca::tools;

    BOOST_AUTO_TEST_SUITE(vec_test)


    BOOST_AUTO_TEST_CASE(test1){
      vecv;
      BOOST_CHECK_EQUAL(...);
      BOOST_CHECK_EQUAL(...);
      :
    }
    BOOST_AUTO_TEST_CASE(test2){
      vecv;
      BOOST_CHECK_EQUAL(...);
      BOOST_CHECK_EQUAL(...);
      :
    }
    :
    BOOST_AUTO_TEST_SUITE_END()
</pre><p>Replace the '...' and ':' with the appropriate syntax. For more info on which boost test macros to use refer to the boost documentation</p>
<ol type="1">
<li>To compile and test the code create a folder tools/build and run the following commands:</li>
</ol>
<pre class="fragment">    cmake -DENABLE_TESTING=ON ../
    make
    make test
</pre><p>Ensure you have an up to date version of cmake or use cmake3</p>
<h3>Testing Across Repos</h3>
<p>There may come a case where changes have to be committed across more than one repo at the same time. Attempting to merge one repo at a time will cause the continuous integration to fail as changes in the other repos will not be pulled in. To do this correctly the following steps should be taken.</p>
<p>Assuming you are in the votca/votca repository: </p><pre class="fragment">git checkout &lt;base_branch&gt;
git submodule update
git checkout -b &lt;some_descriptive_branch_name&gt;
git submodule foreach git remote update
git -C &lt;module1&gt; checkout &lt;sha_or_branch_of_module1_to_test&gt;
git -C &lt;module2&gt; checkout &lt;sha_or_branch_of_module2_to_test&gt;
git add &lt;module1&gt; &lt;module2&gt;
git commit -m "test &lt;module1&gt; with &lt;module2&gt;"
git push origin &lt;some_descriptive_branch_name&gt;
</pre><ol type="1">
<li>Here <code>base_branch</code> will typically be the master or stable branch.</li>
</ol>
<pre class="fragment">    git checkout &lt;base_branch&gt;
</pre><ol type="1">
<li>The submodules are updated to be sure they have incorporated the latest changes in your local repository</li>
</ol>
<pre class="fragment">    git submodule update
</pre><ol type="1">
<li>Create a branch with a descriptive name</li>
</ol>
<pre class="fragment">    git checkout -b &lt;some_descriptive_name&gt;
</pre><ol type="1">
<li>Update each of the submodules, by pulling in any remote changes to the submodules.</li>
</ol>
<pre class="fragment">    git submodule foreach git remote update
</pre><ol type="1">
<li>'-C' changes directory to the submodule directory and then checks out the appropriate commit</li>
</ol>
<pre class="fragment">    git -C &lt;module1&gt; checkout &lt;sha_or_branch_of_module1_to_test&gt;  
    git -C &lt;module2&gt; checkout &lt;sha_or_branch_of_module2_to_test&gt;
</pre><ol type="1">
<li>The changes are then added and commited</li>
</ol>
<pre class="fragment">    git add &lt;module1&gt; &lt;module2&gt;  
    git commit -m "test &lt;module1&gt; with &lt;module2&gt;"
</pre><ol type="1">
<li>Finally, they are pushed to the remote branch</li>
</ol>
<pre class="fragment">    git push origin &lt;some_descriptive_branch_name&gt;
</pre><p>A pull request is then made for the votca/votca repo using the branch name. Once the branch passes all tests it can be merged. Pull requests for each of repos changed can then be made. They will now compile against the updated votca/votca repo. Once they pass their tests they can be merged. If a pull request was already made the travis tests may simply need to be restarted.</p>
<h2>Failed Travis Builds</h2>
<p>There may come a time where one of the docker builds fails. It may be the case that the error message is clear and it can be reproduced on your host os. However, in the case that the error is specific to the enviorment used in the build the local enviornment can be simulated using a docker container.</p>
<p>Before you can use this approach docker must be installed on your host OS. Begin by running a docker image the default is: </p><pre class="fragment">docker run -it votca/buildenv:fedora /bin/bash
</pre><p>This will run an interative docker container which you can interact with in bash . The next commands will need to be adjusted to whatever local environment you need to reproduce to test the error in the travis build.</p>
<h2>CPP Codeing Style Guide</h2>
<p>VOTCA uses a few auto formatting tools to help enforce the rules</p>
<h3><a href="https://clang.llvm.org/docs/ClangFormat.html">clang-format</a></h3>
<p>Automatically ensure consistent formatting for .cc and .h files. The style follows the google style fomatting rules. Have a look at the <code>.clang-format file</code> in the <a href="https://github.com/votca/votca/blob/master/.clang-format">main votca repository</a> for details.</p>
<p>To run the clang-format function on file.cc </p><pre class="fragment">clang-format -i -style=file file.cc
</pre><p>'-i' ensures it will make change to file.cc, omitting the '-i' will display the changes without implementing them. '-style=file' ensures the format is read from the .clang-format file otherwise it will use a default style guide.</p>
<p>By default tabs should not be used to indent, avoid inserting '\t', it is preferable that spaces be used instead.</p>
<h3><a href="https://pypi.org/project/autopep8/0.8/">autopep8</a></h3>
<p>Automatically formats python .py files. We are use the default format rules of autopep8. To run on file.py and update the file run: </p><pre class="fragment">autopep8 -i file.py
</pre><h3><a href="https://github.com/remarkjs/remark">remark</a></h3>
<p>Remark is used to automatically format markdown files .md. Some of the rules applied are:</p>
<ul>
<li>single spaces are used instead of tabs after bullets</li>
<li>bullets are marked with <code>*</code> are used instead of <code>-</code></li>
<li>words are emphasised by placing <code>__</code> on both sides</li>
</ul>
<h3>Automating Formatting</h3>
<p>The above formatters can be automated at every commit using the script found in the <a href="https://github.com/votca/dev-tools">dev-tools</a> repository. To use it copy the file <code>pre-commit</code> to your local .git subfolder to the hooks folder. E.g.</p>
<pre class="fragment">chmod 777 dev-tools/pre-commit  
cp dev-tools/pre-commit tools/.git/hooks/
</pre><p>The above will make the script executable and then copy it to the local .git/hooks directory in the tools repository. The script not only updates the file format of every file staged during a commit it will also update the license date.</p>
<h2>CPP Comment Guide</h2>
<p>It is preferential that the following guidelines be followed when adding comments to code:</p>
<ol type="1">
<li>The <code>/* */</code> comment blocks should be avoided and the <code>//</code> used in their place. This is so that the <code>/* */</code> comment blocks can be easily used for debugging.</li>
<li>It would be preferential that the following doxygen commenting stencil be used in the header files above each class and function description.</li>
</ol>
<pre class="fragment">    /**
    * \brief function/class summary
    *
    * Detailed function/class description if needed
    *
    * @param[in] - description of parameter 1
    * @param[out] - description of parameter 2
    * @param[in,out] - description of parameter 3
    * :
    * @return - description of return type
    */
</pre><p>The doxygen commenting will help future developers maintain the code, in its fully compiled state it may be found at: <a href="http://doc.votca.org">http://doc.votca.org</a></p>
<p>NOTE: Compilation of the doxygen documentation is automated when code is merged into the master votca branch!</p>
<h2>Updating Git Submodules</h2>
<p>Votca with all of its repos can be build by using the parent <a href="https://github.com/votca/votca">votca repo</a>. All the other necessary repos appear as submodules in the parent repo. It is worth noting that the submodules are not automatically updated whenever changes are made to their respective master branches. In essence a submodule refers to a specific commit of the repo it represents. If a new commit is merged into the master branch of a repository the submodule state in the parent repo has to be updated for the commit to propagate to the parent votca repository.</p>
<p>To update the state of a submodule the following commands can be used: </p><pre class="fragment">git submodule foreach git checkout master
git submodule foreach git pull
git add -u
git commit -m "update all submodules"
</pre><h2>Merging With Stable</h2>
<p>When creating a pull request to merge a branch with master the ci test build will by default build agains the master votca branch. This is fine if you are merging with the master branch of a given repo. However, if you would like to merge a bug fix to stable it becomes a problem because you want to build against the stable branch.</p>
<p>Thus to merge with stable the name of the branch to be merged must be prepended with <b>for/stable/</b>. As an example if I have a bug fix for stable I would name it <b>for/stable/bug-fix-1-because-I-am-awesome</b>. When the ci runs it should proceed to make the build correctly.</p>
<h2>Failed Release Builds</h2>
<p>To prepare votca for distribution on different linux flavors there are different requirements from the package managers. Some of the architectures that the package managers support can be quite varied. In the case that a failure occurs on an architecture that is not available to you there are different approaches to debugging the problem. As an example fedora dnf has extended support to the <b>pcc64le</b> architecture. Assuming you have access to fedora you can run the following commands to simulate the build process on the <b>pcc64le</b> architecture: </p><pre class="fragment">dnf update
dnf install qemu-user-static dnf-utils
usermod -a -G mock &lt;username&gt;
mock -r epel-7-ppc64le --forcearch ppc64le --dnf --init
wget https://raw.githubusercontent.com/votca/fedora-copr/master/votca.spec
spectool -g votca.spec
rpmbuild -D"_sourcedir ${PWD}" -D"_srcrpmdir ${PWD}" -bs votca.spec
mock -r epel-7-ppc64le --forcearch ppc64le --dnf --no-clean votca-1.5-1.*.src.rpm
</pre><p>Here, votca-1.5-1 should be replaced with the correct version. The above commands would setup and run the dnf installation process on the <b>pcc64le</b> enviroment. If a bug was found and the build crashes one can interactively intervene by issuing the following command: </p><pre class="fragment">mock -r epel-7-ppc64le --forcearch ppc64le --shell
</pre><p>You will also need to install a text editor if you want to change the source files before running the interactive instance. </p><pre class="fragment">mock -r epel-7-ppc64le --forcearch ppc64le --install vim
</pre><p>Note: we have used this process with the <b>ppc64le</b> architecture as an example, but the same procedure can be extended with different architectures and diferent operating systems. For example you could use the <b>aarch64</b> or <b>armv7hl</b> architecture in place of <b>pcc64le</b>. You could also replace the <b>epel-7-ppc64le</b> os-architecure to <b>fedora-28-ppc64le</b>, <b>fedora-27-aarch64</b> or some other combination. A final point, if you simply want to build natively for instance if you are running fedora on an <b>x86_64</b> machine the <code>frocearch pcc64le</code> in the above case could just be dropped.</p>
<h2>Gitlab Server</h2>
<p>To setup a gitlab server the instructions on the official <a href="https://docs.gitlab.com/runner/register/">gitlab website</a> should be followed. To obtain the access token contact one of the votca administrators. It is also advisable to setup a cron job to help monitor the docker containers, images and volumes which can use a substantial amount of space if not cleaned. A docker cleanup script has been added in the <a href="https://github.com/votca/dev-tools">dev-tools</a> repo, instructions on how to set it up are provided in the script.</p>
<h2>Units in VOTCA</h2>
<p>VOTCA tried as much as possible to standarize units across both CSG and XTP. Externally we parse in the units of the respective file format, e.g. <code>.xyz</code> <code>Angstroem</code>, <code>.gro</code> <code>nm</code>. Internally we convert all parsed units to:</p>
<ul>
<li>CSG: length <code>nm</code>, energy <code>kJ/mol</code> and time <code>ps</code></li>
<li>XTP: length <code>bohr</code>, energy <code>Hartree</code> and time <code>ps</code></li>
</ul>
<h2>Indexing in VOTCA</h2>
<p>All indeces in VOTCA start at <code>0</code>. This is useful, because C++ arrays start at index 0.</p>
<p>Apart from special cases all indeces and integers in votca should be <code><a class="el" href="namespacevotca.html#a3adb2c53d9546e941a81cf310bb8ff16">votca::Index</a></code> which is a typedef for <code>long int</code>. <code>.size()</code> methods of std::containers return an <code>unsigned long int</code> and should be cast to <code><a class="el" href="namespacevotca.html#a3adb2c53d9546e941a81cf310bb8ff16">votca::Index</a></code>. i.e: <code><a class="el" href="namespacevotca.html#a3adb2c53d9546e941a81cf310bb8ff16">votca::Index</a>(vector.size())</code> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
