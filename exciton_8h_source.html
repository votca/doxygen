<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Votca: xtp/src/libxtp/tools/exciton.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Votca
   &#160;<span id="projectnumber">1.5-dev</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_5ead47a849ab83a9193f978ca5e3ca3d.html">xtp</a></li><li class="navelem"><a class="el" href="dir_9490b4b587e39abe5b456b44b7d2a226.html">src</a></li><li class="navelem"><a class="el" href="dir_5cf6e40b1ca54ba1dd4ab59d9906ea77.html">libxtp</a></li><li class="navelem"><a class="el" href="dir_ce85c996d5421e3b61af5ff4ff83117d.html">tools</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">exciton.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="exciton_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* </span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *            Copyright 2009-2017 The VOTCA Development Team</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *                       (http://www.votca.org)</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *      Licensed under the Apache License, Version 2.0 (the &quot;License&quot;)</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * You may not use this file except in compliance with the License.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * You may obtain a copy of the License at</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *              http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * See the License for the specific language governing permissions and</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * limitations under the License.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#ifndef _VOTCA_XTP_EXCITON_H</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define _VOTCA_XTP_EXCITON_H</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="logger_8h.html">votca/ctp/logger.h</a>&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="gwbse_8h.html">votca/xtp/gwbse.h</a>&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="xtp_2include_2votca_2xtp_2qmpackagefactory_8h.html">votca/xtp/qmpackagefactory.h</a>&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="atom_8h.html">votca/ctp/atom.h</a>&gt;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="segment_8h.html">votca/ctp/segment.h</a>&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="constants_8h.html">votca/tools/constants.h</a>&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="linalg_8h.html">votca/tools/linalg.h</a>&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="constants_8h.html">votca/tools/constants.h</a>&gt;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">namespace </span>votca { <span class="keyword">namespace </span>xtp {</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    <span class="keyword">using namespace </span>std;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    </div>
<div class="line"><a name="l00037"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html">   37</a></span>&#160;<span class="keyword">class </span><a class="code" href="classvotca_1_1xtp_1_1Exciton.html">Exciton</a> : <span class="keyword">public</span> <a class="code" href="classvotca_1_1ctp_1_1QMTool.html">ctp::QMTool</a></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;{</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a6d1dd26cb16e7028e54eceb8e3bc9b1d">   41</a></span>&#160;    <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a6d1dd26cb16e7028e54eceb8e3bc9b1d">Exciton</a>() { };</div>
<div class="line"><a name="l00042"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a274a5c6d1f438c439d46ed97b51b9cf4">   42</a></span>&#160;   <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a274a5c6d1f438c439d46ed97b51b9cf4">~Exciton</a>() { };</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a5c33742f4a90e327eb044f7a5dae0164">   44</a></span>&#160;    <span class="keywordtype">string</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a5c33742f4a90e327eb044f7a5dae0164" title="Calculator name.">Identify</a>() { <span class="keywordflow">return</span> <span class="stringliteral">&quot;exciton&quot;</span>; }</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keywordtype">void</span>   Initialize(<a class="code" href="classvotca_1_1tools_1_1Property.html" title="class to manage program options with xml serialization functionality">Property</a> *options);</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordtype">bool</span>   Evaluate();</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160; </div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    </div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adafbe8f1104b0f30496c7af82a8e4987">   54</a></span>&#160;    <span class="keywordtype">string</span>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adafbe8f1104b0f30496c7af82a8e4987">_orbfile</a>; <span class="comment">// file containining the MOs from qmpackage...</span></div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#add136133d8d7f8df322e1853faf9b53c">   55</a></span>&#160;    <span class="keywordtype">string</span>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#add136133d8d7f8df322e1853faf9b53c">_logfile</a>; <span class="comment">// file containining the Energies etc... from qmpackage...</span></div>
<div class="line"><a name="l00056"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ad178c8d4b8777f56c349cca90c47cbe1">   56</a></span>&#160;    <span class="keywordtype">string</span>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ad178c8d4b8777f56c349cca90c47cbe1">_xyzfile</a>;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adaa67c8dc66f8f418578edbd4cdec57b">   58</a></span>&#160;    <span class="keywordtype">string</span>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adaa67c8dc66f8f418578edbd4cdec57b">_package</a>;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a40ee782005ef1317f610c2a4258ccff6">   59</a></span>&#160;    <a class="code" href="classvotca_1_1tools_1_1Property.html" title="class to manage program options with xml serialization functionality">Property</a>    <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a40ee782005ef1317f610c2a4258ccff6">_package_options</a>;</div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a20128e138f0ba597d222ebd1f3586add">   60</a></span>&#160;    <a class="code" href="classvotca_1_1tools_1_1Property.html" title="class to manage program options with xml serialization functionality">Property</a>    <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a20128e138f0ba597d222ebd1f3586add">_gwbse_options</a>;</div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae503645331fd7792e98a183ffd50ef43">   61</a></span>&#160;    <a class="code" href="classvotca_1_1tools_1_1Property.html" title="class to manage program options with xml serialization functionality">Property</a>    <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae503645331fd7792e98a183ffd50ef43">_summary</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    </div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1e53100acc16d65da1dc3bd0dcd97c13">   63</a></span>&#160;    <span class="keywordtype">string</span>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1e53100acc16d65da1dc3bd0dcd97c13">_output_file</a>; <span class="comment">// .orb file to parse to</span></div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#aaa657665583a1b965c7e949adeef934c">   64</a></span>&#160;    <span class="keywordtype">string</span>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#aaa657665583a1b965c7e949adeef934c">_xml_output</a>;    <span class="comment">// .xml output</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac57913d36cd449bf7c7dded8e016bb46">   66</a></span>&#160;    <span class="keywordtype">string</span>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac57913d36cd449bf7c7dded8e016bb46">_reporting</a>;    </div>
<div class="line"><a name="l00067"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac7919e9377a1412a10838ca9765c27b1">   67</a></span>&#160;    <a class="code" href="classvotca_1_1ctp_1_1Logger.html" title="Logger is used for thread-safe output of messages.">ctp::Logger</a>      <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac7919e9377a1412a10838ca9765c27b1">_log</a>;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    </div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac77884afb0f61c40a39dd1f1823fa773">   69</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac77884afb0f61c40a39dd1f1823fa773">_do_dft_input</a>;</div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a57d67ba888bdc5d1c28653c7d5a77906">   70</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a57d67ba888bdc5d1c28653c7d5a77906">_do_dft_run</a>;</div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a2cc24158edfd117f93b6cf8e84521f57">   71</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a2cc24158edfd117f93b6cf8e84521f57">_do_dft_parse</a>;</div>
<div class="line"><a name="l00072"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a96b5d8f930888a893ad84cacc7f20b13">   72</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a96b5d8f930888a893ad84cacc7f20b13">_do_gwbse</a>;</div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a478d7d529c1fdf9b169309ce9eca42ea">   73</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a478d7d529c1fdf9b169309ce9eca42ea">_do_optimize</a>;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    </div>
<div class="line"><a name="l00075"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a2e65f4a2949c82fc931ccb4678994fe4">   75</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a2e65f4a2949c82fc931ccb4678994fe4">_opt_state</a>;</div>
<div class="line"><a name="l00076"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a7e7670575faf08190eff17cc9416049b">   76</a></span>&#160;    <span class="keywordtype">double</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a7e7670575faf08190eff17cc9416049b">_displacement</a>;</div>
<div class="line"><a name="l00077"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a382c6c04e31e946682f7a1adc31a666e">   77</a></span>&#160;    <span class="keywordtype">double</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a382c6c04e31e946682f7a1adc31a666e">_convergence</a>;</div>
<div class="line"><a name="l00078"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#aa247c12f9ea88449434c2a09b7cfaddd">   78</a></span>&#160;    <span class="keywordtype">double</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#aa247c12f9ea88449434c2a09b7cfaddd">_trust_radius</a>;</div>
<div class="line"><a name="l00079"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae7d59ebb94e02f8bc668a69c889be329">   79</a></span>&#160;    <span class="keywordtype">double</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae7d59ebb94e02f8bc668a69c889be329">_trust_radius_max</a>;</div>
<div class="line"><a name="l00080"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ada3c388f964fc735e95b887db7ed6146">   80</a></span>&#160;    <span class="keywordtype">double</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ada3c388f964fc735e95b887db7ed6146">_delta_energy_estimate</a>;</div>
<div class="line"><a name="l00081"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a6c9d1174ac722f8c12c8a00d9aef0673">   81</a></span>&#160;    <span class="keywordtype">double</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a6c9d1174ac722f8c12c8a00d9aef0673">_norm_delta_pos</a>;</div>
<div class="line"><a name="l00082"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a3da1d83257cdd673bb2d2c804c2609be">   82</a></span>&#160;    <span class="keywordtype">string</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a3da1d83257cdd673bb2d2c804c2609be">_spintype</a>;</div>
<div class="line"><a name="l00083"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acdc097a8e182d434f3d782b01c9bb19c">   83</a></span>&#160;    <span class="keywordtype">string</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acdc097a8e182d434f3d782b01c9bb19c">_forces</a>; </div>
<div class="line"><a name="l00084"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a310f65e20650bc5cc08ed8a112ca9730">   84</a></span>&#160;    <span class="keywordtype">string</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a310f65e20650bc5cc08ed8a112ca9730">_opt_type</a>;    </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    </div>
<div class="line"><a name="l00086"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acbd385c53eeebe97986485a48c93ba93">   86</a></span>&#160;    <span class="keywordtype">string</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acbd385c53eeebe97986485a48c93ba93">_guess_orbA</a>;</div>
<div class="line"><a name="l00087"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a612b71749af695efc0eff8945f91437c">   87</a></span>&#160;    <span class="keywordtype">string</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a612b71749af695efc0eff8945f91437c">_guess_orbB</a>;</div>
<div class="line"><a name="l00088"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a7ed02eed0c65dd36e5b70c7c16559d07">   88</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a7ed02eed0c65dd36e5b70c7c16559d07">_do_guess</a>;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    </div>
<div class="line"><a name="l00090"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ab9ab30a4a3578cf80a746c28a6721583">   90</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ab9ab30a4a3578cf80a746c28a6721583">_natoms</a>;</div>
<div class="line"><a name="l00091"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acfb2eeff186ae23f2d38b3f9766c73bc">   91</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acfb2eeff186ae23f2d38b3f9766c73bc">_iteration</a>;</div>
<div class="line"><a name="l00092"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1401723a0256002d5f55905db8036f97">   92</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1401723a0256002d5f55905db8036f97">_force</a>;</div>
<div class="line"><a name="l00093"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adfb338f82dcf15ea3b9e336df1276696">   93</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adfb338f82dcf15ea3b9e336df1276696">_force_old</a>;</div>
<div class="line"><a name="l00094"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac47c34b6025c41eef171bc9f2d55661d">   94</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac47c34b6025c41eef171bc9f2d55661d">_xyz_shift</a>;</div>
<div class="line"><a name="l00095"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1604672bc7b1575402cd5aa9d3ac7d5a">   95</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1604672bc7b1575402cd5aa9d3ac7d5a">_speed</a>;</div>
<div class="line"><a name="l00096"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#aa199a825150e584c0a4ae8747f985d0a">   96</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#aa199a825150e584c0a4ae8747f985d0a">_current_xyz</a>;</div>
<div class="line"><a name="l00097"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acae9e1680de362105746b2b13c0c02aa">   97</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#acae9e1680de362105746b2b13c0c02aa">_old_xyz</a>; </div>
<div class="line"><a name="l00098"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae082b5dc54294e4e2bc67d75a42847c4">   98</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae082b5dc54294e4e2bc67d75a42847c4">_trial_xyz</a>; </div>
<div class="line"><a name="l00099"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adab2d2b8ae2afcebef65cf6ffeef8668">   99</a></span>&#160;    ub::matrix&lt;double&gt; <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#adab2d2b8ae2afcebef65cf6ffeef8668">_hessian</a>;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    </div>
<div class="line"><a name="l00101"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a300621f4d11eb4f6ce1d91700950e6d6">  101</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a300621f4d11eb4f6ce1d91700950e6d6">_step_accepted</a>;</div>
<div class="line"><a name="l00102"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#add8e95706438a66cce7656b009fc785e">  102</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#add8e95706438a66cce7656b009fc785e">_update_hessian</a>;</div>
<div class="line"><a name="l00103"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac59cbfad0619f67cb20e6176ced6837a">  103</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac59cbfad0619f67cb20e6176ced6837a">_restart_opt</a>;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keywordtype">void</span> ExcitationEnergies( <a class="code" href="classvotca_1_1xtp_1_1QMPackage.html">QMPackage</a>* _qmpackage, vector &lt;ctp::Segment* &gt; _segments, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals );</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keywordtype">void</span> ReadXYZ( <a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment, <span class="keywordtype">string</span> filename);</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordtype">void</span> Orbitals2Segment(<a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordtype">void</span> Coord2Segment(<a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment );</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keywordtype">double</span> GetTotalEnergy( <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals, <span class="keywordtype">string</span> _spintype, <span class="keywordtype">int</span> _opt_state );</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="keywordtype">void</span> PrepareGuess(         <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a> *_orbitalsA, </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                               <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a> *_orbitalsB, </div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                               <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a> *_orbitalsAB);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordtype">void</span> OrthonormalizeGuess ( <a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals );</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    </div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordtype">void</span> BFGSStep( <span class="keywordtype">int</span>&amp; _iteration, <span class="keywordtype">bool</span>&amp; _update_hessian,  ub::matrix&lt;double&gt;&amp; _force, ub::matrix&lt;double&gt;&amp; _force_old,  ub::matrix&lt;double&gt;&amp; _current_xyz, ub::matrix&lt;double&gt;&amp;  _old_xyz, ub::matrix&lt;double&gt;&amp; _hessian ,ub::matrix&lt;double&gt;&amp; _xyz_shift ,ub::matrix&lt;double&gt;&amp; _trial_xyz  );</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordtype">void</span> ReloadState();</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordtype">void</span> NumForceForward(<span class="keywordtype">double</span> energy, vector &lt;ctp::Atom* &gt; _atoms, ub::matrix&lt;double&gt;&amp; _force, <a class="code" href="classvotca_1_1xtp_1_1QMPackage.html">QMPackage</a>* _qmpackage,vector &lt;ctp::Segment* &gt; _segments, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals );</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keywordtype">void</span> NumForceCentral(<span class="keywordtype">double</span> energy, vector &lt;ctp::Atom* &gt; _atoms, ub::matrix&lt;double&gt;&amp; _force, <a class="code" href="classvotca_1_1xtp_1_1QMPackage.html">QMPackage</a>* _qmpackage,vector &lt;ctp::Segment* &gt; _segments, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals );</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    </div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordtype">void</span> WriteIteration( FILE* out, <span class="keywordtype">int</span> _iteration, <a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment, ub::matrix&lt;double&gt;&amp; _force  );</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordtype">double</span> getMax( ub::matrix&lt;double&gt;&amp; _matrix );</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordtype">double</span> getRMS( ub::matrix&lt;double&gt;&amp; _matrix );</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    </div>
<div class="line"><a name="l00128"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a39cdf46a9ffba179b35ba3ed25065fa1">  128</a></span>&#160;    <span class="keywordtype">string</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a39cdf46a9ffba179b35ba3ed25065fa1">Convergence</a>( <span class="keywordtype">bool</span> _converged ) { </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        </div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keywordtype">string</span> _converged_string;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="keywordflow">if</span> ( _converged )  _converged_string = <span class="stringliteral">&quot; (converged)&quot;</span>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keywordflow">if</span> ( !_converged )  _converged_string = <span class="stringliteral">&quot; (not converged)&quot;</span>;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="keywordflow">return</span> _converged_string;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    }</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;};</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a8f51a06710222cdb4d5fa4adfbf2f162">  144</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a8f51a06710222cdb4d5fa4adfbf2f162" title="Initializes a calculator from an XML file with options.">Exciton::Initialize</a>(<a class="code" href="classvotca_1_1tools_1_1Property.html" title="class to manage program options with xml serialization functionality">Property</a>* options) {</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            <span class="comment">// update options with the VOTCASHARE defaults   </span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;            UpdateWithDefaults( options, <span class="stringliteral">&quot;xtp&quot;</span> );</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            _do_dft_input = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            _do_dft_run = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            _do_dft_parse = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            _do_gwbse = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            _do_optimize = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            _restart_opt = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            _do_guess=<span class="keyword">false</span>; <span class="comment">//Writing guess for dimer calculation</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="keywordtype">string</span> key = <span class="stringliteral">&quot;options.&quot;</span> + Identify();</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            _output_file = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.archive&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt;();</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            _reporting =  options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.reporting&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="comment">// options for GWBSE package</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <span class="keywordtype">string</span> _gwbse_xml = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.gwbse_options&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <span class="comment">//cout &lt;&lt; endl &lt;&lt; &quot;... ... Parsing &quot; &lt;&lt; _gwbse_xml &lt;&lt; endl ;</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <a class="code" href="namespacevotca_1_1tools.html#af135f0aaaac442ad3d3285a3b1d539b7">load_property_from_xml</a>(_gwbse_options, _gwbse_xml.c_str());</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            <span class="comment">// job tasks</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            <span class="keywordtype">string</span> _tasks_string = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.tasks&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            <span class="keywordflow">if</span> (_tasks_string.find(<span class="stringliteral">&quot;input&quot;</span>) != std::string::npos) _do_dft_input = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            <span class="keywordflow">if</span> (_tasks_string.find(<span class="stringliteral">&quot;dft&quot;</span>) != std::string::npos) _do_dft_run = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            <span class="keywordflow">if</span> (_tasks_string.find(<span class="stringliteral">&quot;parse&quot;</span>) != std::string::npos) _do_dft_parse = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            <span class="keywordflow">if</span> (_tasks_string.find(<span class="stringliteral">&quot;gwbse&quot;</span>) != std::string::npos) _do_gwbse = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            <span class="keywordflow">if</span> (_tasks_string.find(<span class="stringliteral">&quot;optimize&quot;</span>) != std::string::npos) _do_optimize = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            _xml_output = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.output&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            </div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="comment">// something unique</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            <span class="comment">// _package = options-&gt;get(key + &quot;.package&quot;).as&lt;string&gt; ();</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="comment">// options for dft package</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            <span class="keywordtype">string</span> _package_xml = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.dftpackage&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="comment">//cout &lt;&lt; endl &lt;&lt; &quot;... ... Parsing &quot; &lt;&lt; _package_xml &lt;&lt; endl ;</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            <a class="code" href="namespacevotca_1_1tools.html#af135f0aaaac442ad3d3285a3b1d539b7">load_property_from_xml</a>(_package_options, _package_xml.c_str());</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            key = <span class="stringliteral">&quot;package&quot;</span>;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;            _package = _package_options.get(key + <span class="stringliteral">&quot;.name&quot;</span>).as&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            <span class="comment">//cout &lt;&lt; endl &lt;&lt; &quot;... ... Parsing &quot; &lt;&lt; _package_xml &lt;&lt; endl ;</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;             key = <span class="stringliteral">&quot;options.&quot;</span> + Identify();</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            <span class="keywordflow">if</span> ( options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#ad6571e16bf9253f6036b000e15449c79" title="check whether property exists">exists</a>(key+<span class="stringliteral">&quot;.guess&quot;</span>)){</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                _do_guess=<span class="keyword">true</span>;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                _guess_orbA = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.guess.archiveA&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                _guess_orbB = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.guess.archiveB&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;            }</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            key = <span class="stringliteral">&quot;options.&quot;</span> + Identify();</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            <span class="comment">// orbitals file or pure DFT output</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            _orbfile = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.molecule.orbitals&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            _logfile = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.molecule.log&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="comment">// test for parsing an xyz file</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            <span class="keywordflow">if</span> ( _do_dft_input ) {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                _xyzfile = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.molecule.xyz&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt;();</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            }</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            </div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            <span class="comment">// if optimization is chosen</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            <span class="keywordflow">if</span> ( _do_optimize ){</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                  _opt_state = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.state&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">int</span>&gt; ();</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                  _displacement = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.displacement&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">double</span>&gt; ();</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                  _convergence = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.convergence&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">double</span>&gt;();</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                  _spintype = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.spintype&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                  _trust_radius = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.trust&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">double</span>&gt; ();</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                  _forces = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.forces&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                  _opt_type = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.type&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                  <span class="keywordtype">string</span> _restart_string = options-&gt;<a class="code" href="classvotca_1_1tools_1_1Property.html#a3d205067df14b752467239235e0d1895" title="get existing property">get</a>(key + <span class="stringliteral">&quot;.optimize.restart&quot;</span>).<a class="code" href="classvotca_1_1tools_1_1Property.html#ac6d7e21b86efdf7525d0cc9f8e8feb5c" title="return value as type">as</a>&lt;<span class="keywordtype">string</span>&gt; ();</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                  <span class="keywordflow">if</span> ( _restart_string == <span class="stringliteral">&quot;restart&quot;</span> ) _restart_opt = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                  <span class="keywordflow">if</span> ( _restart_opt  &amp;&amp; ! boost::filesystem::exists(<span class="stringliteral">&quot;restart.opt&quot;</span>)) {</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                      cout &lt;&lt; <span class="stringliteral">&quot; ERROR: Restart requested but restart.opt file not found!&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                      exit(1);</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                  };</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            }</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            <span class="comment">// get the path to the shared folders with xml files</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            <span class="comment">//char *votca_share = getenv(&quot;VOTCASHARE&quot;);</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;            <span class="comment">//if (votca_share == NULL) throw std::runtime_error(&quot;VOTCASHARE not set, cannot open help files.&quot;);</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;            <span class="comment">//string xmlFile = string(getenv(&quot;VOTCASHARE&quot;)) + string(&quot;/xtp/packages/&quot;) + _package + string(&quot;_idft_pair.xml&quot;);</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            <span class="comment">//load_property_from_xml(_package_options, xmlFile);</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="comment">// register all QM packages (Gaussian, TURBOMOLE, etc)</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            <a class="code" href="classvotca_1_1xtp_1_1QMPackageFactory.html#abc53251299a917b0880ddd97b68ccdc8">QMPackageFactory::RegisterAll</a>();</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;           </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;}</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae9db4e0a2cee062e1690d44c5187bedd">  234</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae9db4e0a2cee062e1690d44c5187bedd">Exciton::Evaluate</a>() {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    </div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">if</span> ( _reporting == <span class="stringliteral">&quot;silent&quot;</span>)   _log.setReportLevel( <a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a083e7e6de6236e85180a6cdb8373d373">ctp::logERROR</a> ); <span class="comment">// only output ERRORS, GEOOPT info, and excited state info for trial geometry</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">if</span> ( _reporting == <span class="stringliteral">&quot;noisy&quot;</span>)    _log.setReportLevel( <a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a> ); <span class="comment">// OUTPUT ALL THE THINGS</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">if</span> ( _reporting == <span class="stringliteral">&quot;default&quot;</span>)  _log.setReportLevel( <a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a> );  <span class="comment">// </span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    </div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    _log.setMultithreading( <span class="keyword">true</span> );</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    _log.setPreface(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,    <span class="stringliteral">&quot;\n... ...&quot;</span>);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    _log.setPreface(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a083e7e6de6236e85180a6cdb8373d373">ctp::logERROR</a>,   <span class="stringliteral">&quot;\n... ...&quot;</span>);</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    _log.setPreface(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616ab8b20a7bdfde5951cebadba4284a9e4d">ctp::logWARNING</a>, <span class="stringliteral">&quot;\n... ...&quot;</span>);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    _log.setPreface(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,   <span class="stringliteral">&quot;\n... ...&quot;</span>); </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616">ctp::TLogLevel</a> _ReportLevel = _log.getReportLevel( ); <span class="comment">// backup report level</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordflow">if</span> ( _do_optimize ){</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        _trust_radius = _trust_radius * <a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5b8b61ab3a027e6cb419565bd73dea52">tools::conv::ang2bohr</a>; <span class="comment">// initial trust radius in a.u.</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        _trust_radius_max = 0.1; </div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        _displacement = _displacement * <a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5b8b61ab3a027e6cb419565bd73dea52">tools::conv::ang2bohr</a>; <span class="comment">// initial trust radius in a.u.</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        _log.setReportLevel( <a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a> );</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;Requested geometry optimization of excited state &quot;</span> &lt;&lt; _spintype &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _opt_state &lt;&lt; flush; </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;... forces calculation using &quot;</span> &lt;&lt; _forces &lt;&lt; <span class="stringliteral">&quot; differences &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;... displacement for numerical forces:           &quot;</span> &lt;&lt; _displacement &lt;&lt; <span class="stringliteral">&quot; Bohr&quot;</span> &lt;&lt; flush; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;... convergence of total energy:                 &quot;</span> &lt;&lt; _convergence &lt;&lt; <span class="stringliteral">&quot; Hartree&quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;... initial trust radius:                        &quot;</span> &lt;&lt; _trust_radius &lt;&lt; <span class="stringliteral">&quot; Bohr &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        _log.setReportLevel( _ReportLevel );</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    }</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    vector &lt;ctp::Segment* &gt; _segments;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="comment">// Create a new segment</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a> _segment(0, <span class="stringliteral">&quot;mol&quot;</span>);</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                </div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordflow">if</span> (_do_dft_input) {</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;       ReadXYZ( &amp;_segment, _xyzfile );</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;       _segments.push_back(&amp;_segment);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    </div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">// get the corresponding object from the QMPackageFactory</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <a class="code" href="classvotca_1_1xtp_1_1QMPackage.html">QMPackage</a> *_qmpackage =  <a class="code" href="namespacevotca_1_1xtp.html#ab8e4a768849e0692c93b0c165989ce7d">QMPackages</a>().<a class="code" href="classvotca_1_1tools_1_1ObjectFactory.html#af7cdca5a79d3cb0946ceaa92979b9a04">Create</a>( _package );</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#aac4e209848497354b7b92690fdcaa73b">setLog</a>( &amp;_log );       </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a2c4f4a6548a29e4078672c8b3e86f27f">Initialize</a>( &amp;_package_options );</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment">// set the run dir </span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a3de2872e0af410ba663ae053b0083e64">setRunDir</a>(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a> _orbitals;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    </div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    _iteration = 0;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordtype">string</span> _geoopt_preface = <span class="stringliteral">&quot;\n... ... GEOOPT &quot;</span> + <a class="code" href="namespacevotca_1_1tools.html#aa8e6d36442ef233cd3f5d59bbd640127">boost::lexical_cast</a>&lt;std::string&gt;(_iteration);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordflow">if</span> ( _do_optimize ) _log.setPreface(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>, _geoopt_preface );</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    </div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordflow">if</span> ( ! _restart_opt ){</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="comment">// do GWBSE for start geometry</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="keywordflow">if</span> ( _reporting == <span class="stringliteral">&quot;silent&quot;</span> ) _log.setReportLevel( <a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a> );</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    </div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    ExcitationEnergies( _qmpackage, _segments, &amp;_orbitals);</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    }</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;   <span class="comment">// only do this, if optimization is requested </span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;   <span class="keywordflow">if</span> ( _do_optimize ){</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;   </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;      <span class="comment">// optimization implies running DFT for displaced geometries</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      _do_dft_input = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;      _do_dft_run = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      _do_dft_parse = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      <span class="comment">// convergence checks</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;      <span class="keywordtype">bool</span> _converged          = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;      <span class="keywordtype">double</span> energy=0;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;      <span class="keywordflow">if</span> ( _restart_opt ){</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;          <span class="comment">// reload data from restart.opt</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;          ReloadState();</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;          <span class="comment">// exit(0);</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;         <span class="comment">// get total energy for this excited state</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;          energy = GetTotalEnergy( &amp;_orbitals, _spintype, _opt_state );</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;         <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; Total energy at initial geometry for &quot;</span> &lt;&lt; _spintype &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _opt_state &lt;&lt; <span class="stringliteral">&quot; is &quot;</span> &lt;&lt; energy &lt;&lt; <span class="stringliteral">&quot; Hartree &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;         <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;         _log.setReportLevel( _ReportLevel ); <span class="comment">// go silent again during numerical force calculation, if requested</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      }</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;      <span class="comment">//double energy_new;</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;      <span class="comment">// now iterate</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;      <span class="keywordflow">while</span> ( ! _converged ){ </div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;           _geoopt_preface = <span class="stringliteral">&quot;\n... ... GEOOPT &quot;</span> + <a class="code" href="namespacevotca_1_1tools.html#aa8e6d36442ef233cd3f5d59bbd640127">boost::lexical_cast</a>&lt;std::string&gt;(_iteration+1);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;           _log.setPreface(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>, _geoopt_preface );</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;           </div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;           </div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;           vector &lt;ctp::Segment* &gt; _molecule;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;           <a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a> _current_coordinates(0, <span class="stringliteral">&quot;mol&quot;</span>);</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;           <span class="keywordflow">if</span> ( _restart_opt) {</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;               <span class="comment">// fill current coordinates from reloaded data</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;               ReadXYZ( &amp;_current_coordinates, _xyzfile ); <span class="comment">// to initialize</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;               Coord2Segment( &amp;_current_coordinates); <span class="comment">// overwrite coordinates</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;               _molecule.push_back( &amp;_current_coordinates );</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                ExcitationEnergies( _qmpackage, _molecule, &amp;_orbitals);</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                energy = GetTotalEnergy( &amp;_orbitals, _spintype, _opt_state );</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;               _restart_opt = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;           } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;               <span class="comment">// get current coordinates from Orbitals object</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;               Orbitals2Segment( &amp;_current_coordinates , &amp;_orbitals);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;               _molecule.push_back( &amp;_current_coordinates );</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;           }</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;          </div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;           </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;           <span class="comment">// displace all atoms in each cartesian coordinate and get new energy</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;           <span class="comment">// for each atom</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;           vector&lt; ctp::Atom* &gt; _atoms;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;           vector&lt; ctp::Atom* &gt; ::iterator ait;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;           _atoms = _current_coordinates.<a class="code" href="classvotca_1_1ctp_1_1Segment.html#aab099df4198a08de8403c4b6ee38215b">Atoms</a>();</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;           </div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;           <span class="keywordflow">if</span> ( _iteration == 0 ){</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;              _natoms      = _current_coordinates.<a class="code" href="classvotca_1_1ctp_1_1Segment.html#aab099df4198a08de8403c4b6ee38215b">Atoms</a>().size();</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;              </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;              _force       = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;              _force_old   = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;              _xyz_shift   = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;              _current_xyz = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;              _old_xyz     = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;              _trial_xyz   = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;              _hessian     = ub::zero_matrix&lt;double&gt;(3*_natoms,3*_natoms);</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;           }</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;           </div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;           <span class="comment">// calculate numerical forces</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;           <span class="keywordflow">if</span> ( _forces == <span class="stringliteral">&quot;forward&quot;</span> ) NumForceForward( energy, _atoms, _force, _qmpackage, _molecule, &amp;_orbitals );</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;           <span class="keywordflow">if</span> ( _forces == <span class="stringliteral">&quot;central&quot;</span> ) NumForceCentral( energy, _atoms, _force, _qmpackage, _molecule, &amp;_orbitals );</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;           </div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;           </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;           <span class="comment">// writing current coordinates and forces</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;           FILE *out = NULL;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;           vector&lt;ctp::Segment*&gt; ::iterator sit;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;           <span class="keywordtype">string</span> FILENAME = <span class="stringliteral">&quot;geometry_optimization.xyz&quot;</span>;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;           <span class="keywordflow">for</span> (sit = _molecule.begin(); sit &lt; _molecule.end(); ++sit) {</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;             <span class="keywordflow">if</span> ( _iteration == 0 ) {</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                 out = fopen(FILENAME.c_str(),<span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;             }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                 out = fopen(FILENAME.c_str(),<span class="stringliteral">&quot;a&quot;</span>);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;             }</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;              WriteIteration(out,_iteration,(*sit),_force);</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;           }</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;              </div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;           fclose(out);</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;           <span class="keywordflow">if</span> ( _opt_type != <span class="stringliteral">&quot;md&quot;</span> ){</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;           </div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;           _step_accepted = <span class="keyword">false</span>; <span class="comment">// at every iteration</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;           </div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;           <span class="comment">// initial trial -&gt; update Hessian</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;           _update_hessian = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;           <span class="keywordtype">double</span> _RMSForce;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;           <span class="keywordtype">double</span> _MaxForce;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;           <span class="keywordtype">double</span> _RMSStep;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;           <span class="keywordtype">double</span> _MaxStep;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;           <span class="keywordtype">double</span> energy_delta;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;           <span class="keywordtype">double</span> energy_new;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;           <span class="keywordtype">double</span> _old_TR = _trust_radius;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;           <span class="keywordflow">while</span> ( ! _step_accepted ){</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;           </div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;               BFGSStep(_iteration, _update_hessian, _force,_force_old, _current_xyz, _old_xyz, _hessian,  _xyz_shift, _trial_xyz);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;           </div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;               <span class="comment">// put trial coordinates into _segment</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;               <span class="keywordtype">int</span> _i_atom = 0;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;               <span class="keywordflow">for</span> (ait = _atoms.begin(); ait &lt; _atoms.end(); ++ait) {</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                   <span class="comment">// put trial coordinates (_trial_xyz is in Bohr, segments in nm)</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                   <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> _pos_displaced( _trial_xyz(_i_atom,0)*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5334903bb42aab258dbf002d3cef9967">tools::conv::bohr2nm</a> , _trial_xyz(_i_atom,1)*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5334903bb42aab258dbf002d3cef9967">tools::conv::bohr2nm</a>, _trial_xyz(_i_atom,2)*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5334903bb42aab258dbf002d3cef9967">tools::conv::bohr2nm</a> );</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                   (*ait)-&gt;setQMPos(_pos_displaced); <span class="comment">// put updated coordinate into segment</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                   _i_atom++;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;               }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;               <span class="comment">// for the updated geometry, get new reference energy</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;               <span class="keywordflow">if</span> ( _reporting == <span class="stringliteral">&quot;silent&quot;</span> ) _log.setReportLevel( <a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a> );</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;               ExcitationEnergies(_qmpackage, _molecule, &amp;_orbitals);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;               energy_new  = GetTotalEnergy( &amp;_orbitals, _spintype, _opt_state );</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;               </div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;               <span class="comment">// CTP_LOG(ctp::logINFO,_log) &lt;&lt; &quot; Total energy of &quot; &lt;&lt; _spintype &lt;&lt; &quot; &quot; &lt;&lt; _opt_state &lt;&lt; &quot; is &quot; &lt;&lt; energy_new &lt;&lt; &quot; a.u. at &quot; &lt;&lt; _iteration &lt;&lt; flush;</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;               energy_delta = energy_new - energy;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;               _old_TR = _trust_radius;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;               <span class="comment">// check the energy at the trial coordinates</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;               <span class="keywordflow">if</span> ( energy_delta &gt; 0.0 ){</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                   <span class="comment">// total energy has unexpectedly increased, half the trust radius</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                   _trust_radius = 0.5 * _trust_radius;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                   <span class="comment">// Hessian should not be updated for reduced trust radius</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                   _update_hessian = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                   <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; BFGS-TRM: total energy increased, this step is rejected and the new trust radius is: &quot;</span> &lt;&lt; _trust_radius &lt;&lt; endl;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                   <span class="comment">// repeat BGFSStep with new trust radius</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;               } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                   <span class="comment">// total energy has decreased, we accept the step but might update the trust radius</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                   _step_accepted = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                   <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; BFGS-TRM: step accepted&quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                   <span class="comment">// adjust trust radius, if required</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                   <span class="keywordtype">double</span> _tr_check = energy_delta / _delta_energy_estimate;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                   <span class="keywordflow">if</span> ( _tr_check &gt; 0.75 &amp;&amp; 1.25*sqrt(_norm_delta_pos) &gt; _trust_radius ){</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                      _trust_radius = 2.0 * _trust_radius;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                      <span class="comment">// if ( _trust_radius &gt; _trust_radius_max) _trust_radius = _trust_radius_max;</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                      <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; BFGS-TRM: increasing trust radius to &quot;</span> &lt;&lt; _trust_radius &lt;&lt; endl; </div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( _tr_check &lt; 0.25 ) {</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                      _trust_radius = 0.25*sqrt(_norm_delta_pos);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                      <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; BFGS-TRM: reducing trust radius to &quot;</span> &lt;&lt; _trust_radius &lt;&lt; endl;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                   }</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;               </div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                   }</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;           }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;           </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;           <span class="comment">// after the step is accepted, we can shift the stored data   </span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;           energy       = energy_new;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;           _old_xyz     = _current_xyz;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;           _current_xyz = _trial_xyz;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;           _force_old   = _force; </div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;           <span class="comment">// checking convergence</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;           <span class="keywordtype">bool</span> _energy_converged   = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;           <span class="keywordtype">bool</span> _RMSForce_converged = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;           <span class="keywordtype">bool</span> _MaxForce_converged = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;           <span class="keywordtype">bool</span> _RMSStep_converged  = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;           <span class="keywordtype">bool</span> _MaxStep_converged  = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;           _xyz_shift = _current_xyz - _old_xyz;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;           </div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;           _RMSForce = <a class="code" href="namespacevotca_1_1tools.html#a0bedd1e1719273959c5672ff5a8942de" title="returns the rms value of a matrix">linalg_getRMS</a>( _force );</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;           _MaxForce = <a class="code" href="namespacevotca_1_1tools.html#ae0a3ec3895c1b8e8d7552622a89011ea" title="returns the the element with the largest (absolute) value of a matrix">linalg_getMax</a>( _force,<span class="keyword">true</span> );</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;           _RMSStep  = <a class="code" href="namespacevotca_1_1tools.html#a0bedd1e1719273959c5672ff5a8942de" title="returns the rms value of a matrix">linalg_getRMS</a>( _xyz_shift );</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;           _MaxStep  = <a class="code" href="namespacevotca_1_1tools.html#ae0a3ec3895c1b8e8d7552622a89011ea" title="returns the the element with the largest (absolute) value of a matrix">linalg_getMax</a>( _xyz_shift,<span class="keyword">true</span> );</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;           </div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;           <span class="keywordflow">if</span> ( <a class="code" href="namespacevotca_1_1tools.html#abc0c90bbc5f6f5ad2695b3377f7e5684">std::abs</a>(energy_delta) &lt; _convergence) _energy_converged = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;           <span class="keywordflow">if</span> ( <a class="code" href="namespacevotca_1_1tools.html#abc0c90bbc5f6f5ad2695b3377f7e5684">std::abs</a>(_RMSForce) &lt; 0.01 ) _RMSForce_converged = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;           <span class="keywordflow">if</span> ( <a class="code" href="namespacevotca_1_1tools.html#abc0c90bbc5f6f5ad2695b3377f7e5684">std::abs</a>(_MaxForce) &lt; 0.01 ) _MaxForce_converged = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;           <span class="keywordflow">if</span> ( <a class="code" href="namespacevotca_1_1tools.html#abc0c90bbc5f6f5ad2695b3377f7e5684">std::abs</a>(_RMSStep ) &lt; 0.01 ) _RMSStep_converged = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;           <span class="keywordflow">if</span> ( <a class="code" href="namespacevotca_1_1tools.html#abc0c90bbc5f6f5ad2695b3377f7e5684">std::abs</a>(_MaxStep) &lt; 0.01 ) _MaxStep_converged = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;           </div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;           <span class="keywordflow">if</span> ( _energy_converged &amp;&amp; _RMSForce_converged &amp;&amp; _MaxForce_converged &amp;&amp; _RMSStep_converged &amp;&amp; _MaxStep_converged ) _converged = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="comment">// dump information to restart file</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        </div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        FILE *restart;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordtype">string</span> FILE = <span class="stringliteral">&quot;restart.opt&quot;</span>;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        restart = fopen(FILE.c_str(),<span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        fprintf(restart, <span class="stringliteral">&quot;atoms %d \n&quot;</span>, _natoms);</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        fprintf(restart, <span class="stringliteral">&quot;iteration %d \n&quot;</span>, _iteration);</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="comment">// output current xyz</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        fprintf(restart, <span class="stringliteral">&quot;current xyz \n&quot;</span>);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom=0; _i_atom&lt; _natoms; _i_atom++){</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            fprintf(restart, <span class="stringliteral">&quot;%le %le %le \n&quot;</span>, _current_xyz(_i_atom,0) , _current_xyz(_i_atom,1) , _current_xyz(_i_atom,2)  );</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        }</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <span class="comment">// output old xyz</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        fprintf(restart, <span class="stringliteral">&quot;old xyz \n&quot;</span>);</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom=0; _i_atom&lt; _natoms; _i_atom++){</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            fprintf(restart, <span class="stringliteral">&quot;%le %le %le \n&quot;</span>, _old_xyz(_i_atom,0) , _old_xyz(_i_atom,1) , _old_xyz(_i_atom,2)  );</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        }</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment">// output current force</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        fprintf(restart, <span class="stringliteral">&quot;current force \n&quot;</span>);</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom=0; _i_atom&lt; _natoms; _i_atom++){</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            fprintf(restart, <span class="stringliteral">&quot;%le %le %le \n&quot;</span>, _force(_i_atom,0) , _force(_i_atom,1) , _force(_i_atom,2)  );</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        }</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="comment">// output old force</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        fprintf(restart, <span class="stringliteral">&quot;old force \n&quot;</span>);</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom=0; _i_atom&lt; _natoms; _i_atom++){</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            fprintf(restart, <span class="stringliteral">&quot;%le %le %le \n&quot;</span>, _force_old(_i_atom,0) , _force_old(_i_atom,1) , _force_old(_i_atom,2)  );</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        }</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="comment">// output Hessian</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        fprintf(restart, <span class="stringliteral">&quot;Hessian \n&quot;</span>);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> _i = 0; _i &lt; _hessian.size1() ; _i++){</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> _j = 0; _j &lt; _hessian.size2() ; _j++){</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                </div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                fprintf(restart, <span class="stringliteral">&quot;%d %d %le \n&quot;</span>, _i,_j,_hessian(_i,_j)); </div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            }</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        }</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160; </div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        fclose(restart);</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    </div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;           </div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;          </div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;           </div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; Summary of iteration &quot;</span> &lt;&lt; _iteration +1 &lt;&lt; flush;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;    total energy of &quot;</span> &lt;&lt; _spintype &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _opt_state &lt;&lt; <span class="stringliteral">&quot; is &quot;</span> &lt;&lt; energy_new &lt;&lt; <span class="stringliteral">&quot; Hartree &quot;</span>  &lt;&lt; flush;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;    BFGS-TRM: trust radius was &quot;</span> &lt;&lt; _old_TR &lt;&lt; <span class="stringliteral">&quot; Bohr&quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;    convergence: &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;       energy change: &quot;</span> &lt;&lt; setprecision(12) &lt;&lt; energy_delta &lt;&lt; <span class="stringliteral">&quot; a.u. &quot;</span> &lt;&lt; Convergence( _energy_converged ) &lt;&lt; flush;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;       RMS force:     &quot;</span> &lt;&lt; setprecision(12) &lt;&lt; _RMSForce &lt;&lt; Convergence( _RMSForce_converged ) &lt;&lt; flush;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;       Max force:     &quot;</span> &lt;&lt; setprecision(12) &lt;&lt; _MaxForce &lt;&lt; Convergence( _MaxForce_converged ) &lt;&lt; flush;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;       RMS step:      &quot;</span> &lt;&lt; setprecision(12) &lt;&lt; _RMSStep &lt;&lt; Convergence( _RMSStep_converged ) &lt;&lt; flush;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;       Max step:      &quot;</span> &lt;&lt; setprecision(12) &lt;&lt; _MaxStep &lt;&lt; Convergence( _MaxStep_converged ) &lt;&lt; flush;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;       Geometry       &quot;</span> &lt;&lt; Convergence( _converged ) &lt;&lt; flush;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;           <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;           _log.setReportLevel( _ReportLevel ); <span class="comment">// go silent again</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;           </div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;           </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;           _iteration++;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;           <span class="comment">// exit(0);</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;           } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;             _converged = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;           }</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;       } <span class="comment">// optimization while loop</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;       </div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;   }<span class="comment">// if optimization</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  </div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;           </div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;       </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;       <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot;Saving data to &quot;</span> &lt;&lt; _output_file &lt;&lt; flush;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;       std::ofstream ofs( ( _output_file).c_str() );</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;       boost::archive::binary_oarchive oa( ofs );</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;       </div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;       oa &lt;&lt; _orbitals;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;       ofs.close();</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="comment">//Property *_job_output = &amp;_summary.add(&quot;output&quot;,&quot;&quot;);</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <a class="code" href="classvotca_1_1tools_1_1PropertyIOManipulator.html" title="Manipulates the format state of the output stream.">tools::PropertyIOManipulator</a> iomXML(<a class="code" href="classvotca_1_1tools_1_1PropertyIOManipulator.html#ac77f68a3f780f11d8b218f17425dc268a7ceeda9c1e61929aa165b1ab420be364">tools::PropertyIOManipulator::XML</a>, 1, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot;Writing output to &quot;</span> &lt;&lt; _xml_output &lt;&lt; flush;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    std::ofstream ofout (_xml_output.c_str(), std::ofstream::out);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <span class="keywordflow">if</span> ( _do_gwbse ){</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        ofout &lt;&lt; (_summary.get(<span class="stringliteral">&quot;output&quot;</span>));    </div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    }</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    ofout.close();</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;}</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a83c55f755a2448444b63934e0ded5963">  565</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a83c55f755a2448444b63934e0ded5963">Exciton::Coord2Segment</a>( <a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment){</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    </div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            vector&lt; ctp::Atom* &gt; _atoms;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            vector&lt;  ctp::Atom* &gt; ::iterator ait;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;            _atoms = _segment-&gt;<a class="code" href="classvotca_1_1ctp_1_1Segment.html#aab099df4198a08de8403c4b6ee38215b">Atoms</a>();</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;            </div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;            <span class="keywordtype">string</span> type;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;            <span class="keywordtype">int</span> _i_atom = 0;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            <span class="keywordflow">for</span> (ait = _atoms.begin(); ait &lt; _atoms.end(); ++ait) {</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> position(_current_xyz(_i_atom,0)*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5334903bb42aab258dbf002d3cef9967">tools::conv::bohr2nm</a>, _current_xyz(_i_atom,1)*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5334903bb42aab258dbf002d3cef9967">tools::conv::bohr2nm</a>, _current_xyz(_i_atom,2)*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#a5334903bb42aab258dbf002d3cef9967">tools::conv::bohr2nm</a>); <span class="comment">// current_xyz has Bohr, votca stores nm</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                (*ait)-&gt;setQMPos(position);</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                _i_atom++;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;               </div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            }</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            </div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;}</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">/* reload previous optimization state*/</span></div>
<div class="line"><a name="l00586"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ad0d6dd31dda0a3f664172bac28879008">  586</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ad0d6dd31dda0a3f664172bac28879008">Exciton::ReloadState</a>(){</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    </div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="comment">// open restart.opt</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    ifstream in;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordtype">string</span> _filename = <span class="stringliteral">&quot;restart.opt&quot;</span>;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot; Reloading from restart.opt &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    in.open(_filename.c_str(), ios::in);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <span class="keywordflow">if</span> (!in) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Error reading coordinates from restart.opt&quot;</span>));</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordtype">string</span> label;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keywordtype">string</span> type;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="comment">// atoms</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    in &gt;&gt; label;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="keywordflow">if</span> ( label != <span class="stringliteral">&quot;atoms&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected atoms in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    in &gt;&gt; _natoms;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="comment">// initialize matrices</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    _force       = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    _force_old   = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    _xyz_shift   = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    _current_xyz = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    _old_xyz     = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    _trial_xyz   = ub::zero_matrix&lt;double&gt;(_natoms ,3);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    _hessian     = ub::zero_matrix&lt;double&gt;(3*_natoms,3*_natoms);</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    </div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="comment">// info about last iteration</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    in &gt;&gt; label;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="keywordflow">if</span> ( label != <span class="stringliteral">&quot;iteration&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected iteration in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    in &gt;&gt; _iteration;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="comment">// current xyz</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    in &gt;&gt; label; </div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="keywordflow">if</span> ( label != <span class="stringliteral">&quot;current&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected current xyz in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    in &gt;&gt; type;</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="keywordflow">if</span> ( type != <span class="stringliteral">&quot;xyz&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected current xyz in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="keywordtype">int</span> _i_atom = 0;</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keywordflow">while</span> ( _i_atom &lt; _natoms ){</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        in &gt;&gt; _current_xyz(_i_atom,0);</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        in &gt;&gt; _current_xyz(_i_atom,1);</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        in &gt;&gt; _current_xyz(_i_atom,2);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        _i_atom++;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    }</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="comment">// old xyz</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    in &gt;&gt; label; </div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">if</span> ( label != <span class="stringliteral">&quot;old&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected old xyz in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    in &gt;&gt; type;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keywordflow">if</span> ( type != <span class="stringliteral">&quot;xyz&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected old xyz in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    _i_atom = 0;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">while</span> ( _i_atom &lt; _natoms ){</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        in &gt;&gt; _old_xyz(_i_atom,0);</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        in &gt;&gt; _old_xyz(_i_atom,1);</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        in &gt;&gt; _old_xyz(_i_atom,2);</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        _i_atom++;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    }</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    </div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="comment">// current force</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    in &gt;&gt; label; </div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="keywordflow">if</span> ( label != <span class="stringliteral">&quot;current&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected current force in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    in &gt;&gt; type;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="keywordflow">if</span> ( type != <span class="stringliteral">&quot;force&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected current force in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    _i_atom = 0;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keywordflow">while</span> ( _i_atom &lt; _natoms ){</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        in &gt;&gt; _force(_i_atom,0);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        in &gt;&gt; _force(_i_atom,1);</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        in &gt;&gt; _force(_i_atom,2);</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        _i_atom++;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    }   </div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="comment">// old force</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    in &gt;&gt; label; </div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    <span class="keywordflow">if</span> ( label != <span class="stringliteral">&quot;old&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected old force in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    in &gt;&gt; type;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="keywordflow">if</span> ( type != <span class="stringliteral">&quot;force&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected old force in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    _i_atom = 0;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="keywordflow">while</span> ( _i_atom &lt; _natoms ){</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        in &gt;&gt; _force_old(_i_atom,0);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        in &gt;&gt; _force_old(_i_atom,1);</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        in &gt;&gt; _force_old(_i_atom,2);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        _i_atom++;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    }   </div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;       </div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    <span class="comment">// hessian</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordtype">int</span> _i_in;</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keywordtype">int</span> _j_in;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    in &gt;&gt; label; </div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keywordflow">if</span> ( label != <span class="stringliteral">&quot;Hessian&quot;</span> ) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Expected Hessian in restart.opt&quot;</span>));</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i =0 ; _i &lt; 3*_natoms; _i++){</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _j =0 ; _j &lt; 3*_natoms; _j++){</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            in &gt;&gt; _i_in;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            in &gt;&gt; _j_in;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;            in &gt;&gt; _hessian(_i,_j);</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        }</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    }</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    </div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;}</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="comment">/* Calculate forces on atoms numerically by central differences */</span></div>
<div class="line"><a name="l00687"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a3eca817f8c315368c142267f624ce83b">  687</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a3eca817f8c315368c142267f624ce83b">Exciton::NumForceCentral</a>(<span class="keywordtype">double</span> energy, vector&lt;ctp::Atom*&gt; _atoms, ub::matrix&lt;double&gt;&amp; _force, </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <a class="code" href="classvotca_1_1xtp_1_1QMPackage.html">QMPackage</a>* _qmpackage, vector&lt;ctp::Segment*&gt; _molecule, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals){</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    </div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    vector&lt; ctp::Atom* &gt; ::iterator ait;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="keywordtype">int</span> _i_atom = 0;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <span class="keywordflow">for</span> (ait = _atoms.begin(); ait &lt; _atoms.end(); ++ait) {</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;       <span class="comment">// get its current coordinates</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;       <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> _current_pos = (*ait)-&gt;getQMPos(); <span class="comment">// in nm</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    </div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;       <span class="comment">// go through all cartesian components</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_cart = 0 ; _i_cart &lt; 3; _i_cart++ ){</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;           </div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;           <span class="comment">// get displacement vector in positive direction</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;           <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> _displaced(0, 0, 0);</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;           <span class="keywordflow">if</span> (_i_cart == 0) {</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;              _displaced.<a class="code" href="classvotca_1_1tools_1_1vec.html#a03e72336cbfe314a5b4421124f53326b">setX</a>(_displacement / <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a> ); <span class="comment">// x, _displacement in Bohr</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;              _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#ab45304f25d8d52b149491a05b1c09a43" title="read only access to x element">getX</a>() * <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;           }</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;           <span class="keywordflow">if</span> (_i_cart == 1) {</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;              _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#a272a8c6a3be544a2b9dd4b9f5960b02f" title="read only access to y element">getY</a>() * <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;              _displaced.<a class="code" href="classvotca_1_1tools_1_1vec.html#a28cdb83cb7eae520cfaa59bf5852017f">setY</a>(_displacement / <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a> ); <span class="comment">// y, _displacement in in Angstrom</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;           }</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;           <span class="keywordflow">if</span> (_i_cart == 2) {</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;              _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#acc1ceb986d70006789a06cf60169dea4" title="read only access to z element">getZ</a>() * <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;              _displaced.<a class="code" href="classvotca_1_1tools_1_1vec.html#a93bf2c6d0d83ebb9d09fcb04ee023597">setZ</a>(_displacement / <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a> ); <span class="comment">// z, _displacement in in Angstrom</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;           }</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                            </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;           <span class="comment">// update the coordinate</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;           <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> _pos_displaced = _current_pos + _displaced;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;           (*ait)-&gt;setQMPos(_pos_displaced); <span class="comment">// put updated coordinate into segment</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;           <span class="comment">// run DFT and GW-BSE for this geometry</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;           ExcitationEnergies(_qmpackage, _molecule, _orbitals);</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                            </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;           <span class="comment">// get total energy for this excited state</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;           <span class="keywordtype">double</span> energy_displaced_plus = GetTotalEnergy(_orbitals, _spintype, _opt_state);</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;           </div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;           <span class="comment">// get displacement vector in negative direction</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;           <span class="comment">// update the coordinate</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;           _pos_displaced = _current_pos - 2.0 * _displaced;</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;           (*ait)-&gt;setQMPos(_pos_displaced); <span class="comment">// put updated coordinate into segment</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;           <span class="comment">// run DFT and GW-BSE for this geometry</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;           ExcitationEnergies(_qmpackage, _molecule, _orbitals);</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                            </div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;           <span class="comment">// get total energy for this excited state</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;           <span class="keywordtype">double</span> energy_displaced_minus = GetTotalEnergy(_orbitals, _spintype, _opt_state);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;           </div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;           <span class="comment">// calculate force and put into matrix</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;           _force(_i_atom,_i_cart) = 0.5 * (energy_displaced_minus - energy_displaced_plus) / _displacement ; <span class="comment">// force a.u./a.u.</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                                                  </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;           (*ait)-&gt;setQMPos(_current_pos); <span class="comment">// restore original coordinate into segment</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        }</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;               </div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;      _i_atom++;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;   }</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;}</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">/* Calculate forces on atoms numerically by forward differences */</span></div>
<div class="line"><a name="l00754"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac883cd1fc446a68c54af9ac9d454683e">  754</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac883cd1fc446a68c54af9ac9d454683e">Exciton::NumForceForward</a>(<span class="keywordtype">double</span> energy, vector&lt;ctp::Atom*&gt; _atoms, ub::matrix&lt;double&gt;&amp; _force, </div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        <a class="code" href="classvotca_1_1xtp_1_1QMPackage.html">QMPackage</a>* _qmpackage, vector&lt;ctp::Segment*&gt; _molecule, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals){</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    </div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="comment">// check if file &quot;forces.resume&quot; exists</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="keywordtype">string</span> _filename = <span class="stringliteral">&quot;forces.resume&quot;</span>;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordtype">bool</span> _forcefile_exists = boost::filesystem::exists(_filename);</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    ifstream in;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="keywordtype">bool</span> _forces_resume = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="keywordtype">double</span> f_in;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="keywordflow">if</span> ( _forcefile_exists ) {</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        <span class="comment">// get iteration number</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        in.open(_filename.c_str(), ios::in);</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <span class="keywordtype">int</span> _iter_resume;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        in &gt;&gt; _iter_resume;</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        <span class="keywordflow">if</span> ( _iter_resume != _iteration ){</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot; Forces in &quot;</span> &lt;&lt; _filename &lt;&lt; <span class="stringliteral">&quot; from iteration &quot;</span> &lt;&lt; _iter_resume &lt;&lt; <span class="stringliteral">&quot; and not iteration &quot;</span> &lt;&lt; _iteration &lt;&lt; flush;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;            <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot;  discard data...&quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot; Resuming force calculation from  &quot;</span> &lt;&lt; _filename &lt;&lt; flush;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            _forces_resume = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            in &gt;&gt; f_in;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        }</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    }</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    ofstream out;</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    vector&lt; ctp::Atom* &gt; ::iterator ait;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="keywordtype">int</span> _i_atom = 0;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keywordflow">for</span> (ait = _atoms.begin(); ait &lt; _atoms.end(); ++ait) {</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        </div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;          <span class="comment">// get its current coordinates</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;          <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> _current_pos = (*ait)-&gt;getQMPos(); <span class="comment">// in nm</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;          <span class="comment">//       if ( _i_atom &lt; 2 ) {        </span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;          <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_cart = 0 ; _i_cart &lt; 3; _i_cart++ ){</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;             <span class="comment">// try reading from forces.resume</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;             <span class="keywordflow">if</span> ( _forces_resume &amp;&amp; !in.eof()){</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                 cout &lt;&lt; <span class="stringliteral">&quot; reading &quot;</span> &lt;&lt; _i_atom &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _i_cart &lt;&lt; endl;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                _force(_i_atom,_i_cart) = f_in;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                in &gt;&gt; f_in;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                <span class="keywordflow">if</span> (_i_cart == 0) {</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                   _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#ab45304f25d8d52b149491a05b1c09a43" title="read only access to x element">getX</a>() *  <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                }</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                <span class="keywordflow">if</span> (_i_cart == 1) {</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                 _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#a272a8c6a3be544a2b9dd4b9f5960b02f" title="read only access to y element">getY</a>() *  <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                <span class="keywordflow">if</span> (_i_cart == 2) {</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                 _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#acc1ceb986d70006789a06cf60169dea4" title="read only access to z element">getZ</a>() *  <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                }</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;             } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        </div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                 <span class="keywordflow">if</span> ( in.is_open() ) {</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                     <span class="comment">// close for reading</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                     in.close();</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                     out.open( _filename.c_str(), ios::app  );</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                 } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                     <span class="comment">// and open to append</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                     <span class="keywordflow">if</span> ( ! out.is_open() ) {</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                         out.open( _filename.c_str(), ios::app  );</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                         out &lt;&lt; _iteration &lt;&lt; endl;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                     }</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                 }    </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                 cout &lt;&lt; <span class="stringliteral">&quot; calculating &quot;</span> &lt;&lt; _i_atom &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _i_cart &lt;&lt; endl;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;              </div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;              <span class="comment">// get displacement vector</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;              <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> _displaced(0, 0, 0);</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;              <span class="keywordflow">if</span> (_i_cart == 0) {</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                 _displaced.<a class="code" href="classvotca_1_1tools_1_1vec.html#a03e72336cbfe314a5b4421124f53326b">setX</a>(_displacement / <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a> ); <span class="comment">// x, _displacement in Bohr</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                 _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#ab45304f25d8d52b149491a05b1c09a43" title="read only access to x element">getX</a>()*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;              }</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;              <span class="keywordflow">if</span> (_i_cart == 1) {</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                 _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#a272a8c6a3be544a2b9dd4b9f5960b02f" title="read only access to y element">getY</a>()* <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                 _displaced.<a class="code" href="classvotca_1_1tools_1_1vec.html#a28cdb83cb7eae520cfaa59bf5852017f">setY</a>(_displacement /  <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a> ); <span class="comment">// y, _displacement in in Angstrom</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;              }</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;              <span class="keywordflow">if</span> (_i_cart == 2) {</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                 _current_xyz(_i_atom,_i_cart ) = _current_pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#acc1ceb986d70006789a06cf60169dea4" title="read only access to z element">getZ</a>() *  <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a>; <span class="comment">// in Bohr</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                 _displaced.<a class="code" href="classvotca_1_1tools_1_1vec.html#a93bf2c6d0d83ebb9d09fcb04ee023597">setZ</a>(_displacement /  <a class="code" href="namespacevotca_1_1tools_1_1conv.html#af16c23555a307b8becce3eb4ccfed30b">tools::conv::nm2bohr</a> ); <span class="comment">// z, _displacement in in Angstrom</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;              }</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                            </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;              <span class="comment">// update the coordinate</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;              <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> _pos_displaced = _current_pos + _displaced;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;              (*ait)-&gt;setQMPos(_pos_displaced); <span class="comment">// put updated coordinate into segment</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;              <span class="comment">// run DFT and GW-BSE for this geometry</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;              ExcitationEnergies(_qmpackage, _molecule, _orbitals);</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                            </div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;              <span class="comment">// get total energy for this excited state</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;              <span class="keywordtype">double</span> energy_displaced = GetTotalEnergy(_orbitals, _spintype, _opt_state);</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;              <span class="comment">// calculate force and put into matrix</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;           </div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;              _force(_i_atom,_i_cart) = (energy - energy_displaced) / _displacement ; <span class="comment">// force a.u./a.u.</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;              cout &lt;&lt; <span class="stringliteral">&quot;writing force &quot;</span> &lt;&lt; _i_atom &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _i_cart &lt;&lt; endl;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;              out &lt;&lt; setprecision(12) &lt;&lt; _force(_i_atom,_i_cart) &lt;&lt; endl;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;              </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;              </div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;              </div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;              (*ait)-&gt;setQMPos(_current_pos); <span class="comment">// restore original coordinate into segment</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;           }</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;          }  </div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      _i_atom++;</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;   </div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    }</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    </div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    <span class="keywordflow">if</span> ( out.is_open() ) out.close();</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;}</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div>
<div class="line"><a name="l00866"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac64a24dac3da4693f04fbfa7ca242e74">  866</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ac64a24dac3da4693f04fbfa7ca242e74">Exciton::BFGSStep</a>(<span class="keywordtype">int</span>&amp; _iteration, <span class="keywordtype">bool</span>&amp; _update_hessian, ub::matrix&lt;double&gt;&amp; _force, ub::matrix&lt;double&gt;&amp; _force_old, ub::matrix&lt;double&gt;&amp; _current_xyz, ub::matrix&lt;double&gt;&amp; _old_xyz, ub::matrix&lt;double&gt;&amp; _hessian, ub::matrix&lt;double&gt;&amp; _shift, ub::matrix&lt;double&gt;&amp; _trial_xyz){</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="comment">// stuff to prepare</span></div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    ub::vector&lt;double&gt; _total_force(3,0.0);</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keywordtype">double</span> _force_norm = 0.0;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom = 0 ; _i_atom &lt; _natoms; _i_atom++ ){</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_cart = 0; _i_cart &lt; 3; _i_cart++ ){</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;           _total_force( _i_cart ) += _force(_i_atom,_i_cart);</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;           _force_norm += _force(_i_atom,_i_cart)*_force(_i_atom,_i_cart);</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        }</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    }</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    cout &lt;&lt; <span class="stringliteral">&quot;Total force: &quot;</span> &lt;&lt; _total_force(0) &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _total_force(1) &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; _total_force(2) &lt;&lt; endl;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            </div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="comment">// remove CoM force</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; ----------------- Forces ------------------- &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; Atom        x-comp       y-comp      z-comp  &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom = 0 ; _i_atom &lt; _natoms; _i_atom++ ){</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;      <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_cart = 0; _i_cart &lt; 3; _i_cart++ ){</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        <span class="comment">// _force(_i_atom,_i_cart) -= _total_force(_i_cart)/_natoms;</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;       }</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt;  _i_atom &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt;  _force(_i_atom,0) &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt;  _force(_i_atom,1) &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt;  _force(_i_atom,2) &lt;&lt; endl;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; -------------------------------------------- &quot;</span> &lt;&lt; flush;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="comment">// construct vectors</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="keywordtype">int</span> _dim = 3*_natoms;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    ub::vector&lt;double&gt; _previous_pos(_dim,0.0);</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    ub::vector&lt;double&gt; _current_pos(_dim,0.0);</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    ub::vector&lt;double&gt; _previous_gradient(_dim,0.0);</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    ub::vector&lt;double&gt; _current_gradient(_dim,0.0);</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    </div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom = 0 ; _i_atom &lt; _natoms; _i_atom++ ){</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_cart = 0; _i_cart &lt; 3; _i_cart++ ){</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;            <span class="keywordtype">int</span> _idx = 3*_i_atom + _i_cart;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;            _previous_pos( _idx ) = _old_xyz( _i_atom, _i_cart);</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;            _current_pos( _idx ) = _current_xyz( _i_atom, _i_cart);</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;            _previous_gradient( _idx ) = -_force_old( _i_atom, _i_cart);</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;            _current_gradient( _idx ) = -_force( _i_atom, _i_cart);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;            </div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        }</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    }</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    </div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    <span class="comment">// delta is new - old</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    ub::vector&lt;double&gt; _delta_pos =  _current_pos - _previous_pos;</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    _norm_delta_pos = ub::inner_prod(_delta_pos,_delta_pos);</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    </div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    </div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    <span class="comment">// update of Hessian only in first trial </span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="keywordflow">if</span> ( _update_hessian ){</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    </div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;       <span class="comment">// we have no Hessian in the first iteration =&gt; start with something</span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;       <span class="keywordflow">if</span> ( _iteration == 0 ) {</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        </div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;           <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i = 0; _i &lt; _dim; _i++){</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;               _hessian(_i,_i) = 1.0; <span class="comment">// unit matrix</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;           }</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        </div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;       } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;           <span class="comment">/* for later iteration, we can make use of an iterative refinement of </span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="comment">            * the initial Hessian based on the gradient (force) history</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;        </div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;           ub::vector&lt;double&gt; _delta_gradient = _current_gradient - _previous_gradient;</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        </div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;           <span class="comment">// second term in BFGS update (needs current Hessian)</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;           ub::vector&lt;double&gt; _temp1 = <a class="code" href="namespaceboost_1_1numeric_1_1ublas.html#a7469e86915702a005be35a731cac8042">ub::prod</a>(_hessian,_delta_pos);</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;           ub::vector&lt;double&gt; _temp2 = <a class="code" href="namespaceboost_1_1numeric_1_1ublas.html#a7469e86915702a005be35a731cac8042">ub::prod</a>(ub::trans(_delta_pos),_hessian);</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;           _hessian -= ub::outer_prod(_temp1,_temp2) / ub::inner_prod(_delta_pos,_temp1);</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;        </div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;           <span class="comment">// first term in BFGS update</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;           _hessian += ub::outer_prod(_delta_gradient,_delta_gradient)/ub::inner_prod( _delta_gradient,_delta_pos);</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;           <span class="comment">// symmetrize Hessian (since d2E/dxidxj should be symmetric)</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;           <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i = 0; _i &lt; _dim; _i++){</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;               <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _j = _i+1; _j &lt; _dim; _j++){</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;                   <span class="keywordtype">double</span> _sum = 0.5*( _hessian(_i,_j) + _hessian(_j,_i) );</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                   _hessian(_i,_j) = _sum;</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                   _hessian(_j,_i) = _sum;</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;               }</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;           }</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        </div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;       }</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    } <span class="comment">// update Hessian</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    </div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    </div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="comment">// get inverse of the Hessian</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    ub::matrix&lt;double&gt; _hessian_inverse;</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    <a class="code" href="namespacevotca_1_1tools.html#ab8df58c91d84820242aa10f0976cc569" title="inverts A">linalg_invert</a>(_hessian,_hessian_inverse);</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    </div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="comment">// new displacements for the atoms</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    _delta_pos      = -<a class="code" href="namespaceboost_1_1numeric_1_1ublas.html#a7469e86915702a005be35a731cac8042">ub::prod</a>(_hessian_inverse,_current_gradient);</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    _norm_delta_pos = ub::inner_prod(_delta_pos,_delta_pos);</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    </div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    <span class="comment">// TRM -&gt; trust radius check</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="keywordtype">double</span> _trust_radius_squared = _trust_radius * _trust_radius;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordtype">double</span> _max_step_squared = 0.0;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    </div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <span class="comment">// cout &lt;&lt; &quot; step sq &quot; &lt;&lt; _norm_delta_pos &lt;&lt; &quot; vs. TR sq&quot; &lt;&lt; _trust_radius_squared &lt;&lt; endl;</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="keywordflow">if</span> ( _norm_delta_pos &gt; _trust_radius_squared ){</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        </div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="comment">// get eigenvalues and eigenvectors of Hessian</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        ub::matrix&lt;double&gt; _eigenvectors;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        ub::vector&lt;double&gt; _eigenvalues;</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        <a class="code" href="namespacevotca_1_1tools.html#ab29bd4cf7f06c8ad16869b35746e053a" title="eigenvalues of a symmetric matrix A*x=E*x">linalg_eigenvalues</a>( _hessian, _eigenvalues, _eigenvectors);</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        </div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>, _log) &lt;&lt; <span class="stringliteral">&quot; BFGS-TRM: Lowest eigenvalue of Hessian is... &quot;</span> &lt;&lt; _eigenvalues(0) &lt;&lt; flush;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    </div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="comment">// start value for lambda  a bit lower than lowest eigenvalue of Hessian</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        <span class="keywordtype">double</span> _lambda;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="keywordflow">if</span> ( _eigenvalues(0) &gt; 0.0 ){</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            _lambda = -0.05 * <a class="code" href="namespacevotca_1_1tools.html#abc0c90bbc5f6f5ad2695b3377f7e5684">std::abs</a>( _eigenvalues(0) );</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;            _lambda = 1.05*_eigenvalues(0);</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        }</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        </div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        <span class="comment">// for constrained step, we expect</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        _max_step_squared = _norm_delta_pos ;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        <span class="keywordflow">while</span> ( _max_step_squared &gt; _trust_radius_squared ){</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;           _max_step_squared = 0.0;</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;           _lambda -= 0.05*  <a class="code" href="namespacevotca_1_1tools.html#abc0c90bbc5f6f5ad2695b3377f7e5684">std::abs</a>( _eigenvalues(0) ); </div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;           <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i =0 ; _i &lt; _dim; _i++ ){</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;               ub::vector&lt;double&gt; _slice(_dim,0.0);</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;               <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _j =0 ; _j&lt; _dim ; _j++){</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                   _slice(_j) = _eigenvectors(_j,_i);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;               }</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;               </div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;               <span class="comment">//cout &lt;&lt; &quot; forece is of dim &quot; &lt;&lt; _current_force.size1() &lt;&lt; &quot;  &quot; &lt;&lt; _current_force.size2() &lt;&lt; endl;</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;               <span class="keywordtype">double</span> _temp = ub::inner_prod(_slice,_current_gradient);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;               <span class="comment">//cout &lt;&lt; &quot; slice is of dim &quot; &lt;&lt; _slice.size1() &lt;&lt; &quot;  &quot; &lt;&lt; _slice.size2() &lt;&lt; endl;            cout &lt;&lt; &quot; tmep is of dim &quot; &lt;&lt; _temp.size1() &lt;&lt; &quot;  &quot; &lt;&lt; _temp.size2() &lt;&lt; endl;</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;               <span class="comment">// cout &lt;&lt; &quot; into max_step_sq &quot; &lt;&lt; _temp &lt;&lt; &quot; and  &quot;  &lt;&lt; ( _eigenvalues(_i) - _lambda ) &lt;&lt; endl;</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;               _max_step_squared += _temp * _temp /( _eigenvalues(_i) - _lambda ) / ( _eigenvalues(_i) - _lambda ) ;</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;           }</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        }</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot; BFGS-TRM: with lambda &quot;</span> &lt;&lt; _lambda &lt;&lt; <span class="stringliteral">&quot; max step sq is &quot;</span> &lt;&lt; _max_step_squared &lt;&lt; flush;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        </div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        _delta_pos = ub::zero_vector&lt;double&gt;(_dim);</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i =0 ; _i &lt; _dim; _i++ ){</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;            ub::vector&lt;double&gt; _slice(_dim,0.0);</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;            <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _j =0 ; _j&lt; _dim ; _j++){</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                _slice(_j) = _eigenvectors(_j,_i);</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;            }</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            </div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            _delta_pos -= _slice * ub::inner_prod(_slice,_current_gradient)/  ( _eigenvalues(_i) - _lambda ) ; </div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        }</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        </div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        _norm_delta_pos = ub::inner_prod(_delta_pos,_delta_pos); <span class="comment">//_max_step_squared; </span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    }</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    </div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    </div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    </div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    </div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    </div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    </div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    ub::vector&lt;double&gt; _new_pos = _current_pos + _delta_pos;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot;BFGS-TRM: step &quot;</span> &lt;&lt; sqrt(_norm_delta_pos) &lt;&lt; <span class="stringliteral">&quot; vs TR &quot;</span> &lt;&lt; sqrt(_trust_radius_squared) &lt;&lt; flush  ;</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    <span class="comment">// get the energy estimate for a local quadratic surface</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    ub::vector&lt;double&gt; _temp_ene = <a class="code" href="namespaceboost_1_1numeric_1_1ublas.html#a7469e86915702a005be35a731cac8042">ub::prod</a>( _hessian, _delta_pos );</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    _delta_energy_estimate = ub::inner_prod( _current_gradient, _delta_pos ) + 0.5 * ub::inner_prod(_delta_pos,_temp_ene );</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot; BFGS-TRM: estimated energy change: &quot;</span> &lt;&lt; setprecision(12) &lt;&lt; _delta_energy_estimate &lt;&lt; endl;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;   </div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="comment">// update atom coordinates</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    ub::vector&lt;double&gt; _total_shift(3,0.0);</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_atom = 0; _i_atom &lt; _natoms; _i_atom++){</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> _i_cart = 0; _i_cart &lt; 3; _i_cart++ ){</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;             <span class="keywordtype">int</span> _idx = 3*_i_atom + _i_cart;</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            <span class="comment">//_current_xyz(_i_atom,_i_cart) = _new_pos(_idx);</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;             _trial_xyz(_i_atom,_i_cart) = _new_pos(_idx);</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            _total_shift(_i_cart) += _delta_pos(_idx);</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        }</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    }</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;   <span class="comment">/* </span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment">    // make sure there is no CoM movement</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment">       for ( int _i_atom = 0; _i_atom &lt; _natoms; _i_atom++){</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">        for ( int _i_cart = 0; _i_cart &lt; 3; _i_cart++ ){</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment">             //int _idx = 3*_i_atom + _i_cart;</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="comment">            //_current_xyz(_i_atom,_i_cart) -= _total_shift(_i_cart)/_natoms;</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="comment">            // _trial_xyz(_i_atom,_i_cart) -= _total_shift(_i_cart)/_natoms;</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;}</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div>
<div class="line"><a name="l01054"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a37d42a722c9c471053295e8e64c9f9ba"> 1054</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a37d42a722c9c471053295e8e64c9f9ba">Exciton::ExcitationEnergies</a>(<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html">QMPackage</a>* _qmpackage, vector&lt;ctp::Segment*&gt; _segments, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals){</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <span class="keywordflow">if</span> ( _do_dft_input ){</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a> *_orbitalsAB = NULL;        </div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="keywordflow">if</span> ( _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a14ded6615e6aa46efa4bcacecd38f4cb">GuessRequested</a>() &amp;&amp; _do_guess) { <span class="comment">// do not want to do an SCF loop for a dimer</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a8c6c5f605ebba63a742e19471883f0bb">ctp::logINFO</a>,_log) &lt;&lt; <span class="stringliteral">&quot;Guess requested, reading molecular orbitals&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;           </div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a> _orbitalsA, _orbitalsB;   </div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;            _orbitalsAB = <span class="keyword">new</span> <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>();</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;            <span class="comment">// load the corresponding monomer orbitals and prepare the dimer guess </span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;            </div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;            <span class="comment">// failed to load; wrap-up and finish current job</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;            <span class="keywordflow">if</span> ( !_orbitalsA.<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#ac8f73a630d462288a5032b0b812688fc">Load</a>( _guess_orbA ) ) {</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;               <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Do input: failed loading orbitals from &quot;</span>)+_guess_orbA);</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;            }</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            </div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            <span class="keywordflow">if</span> ( !_orbitalsB.<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#ac8f73a630d462288a5032b0b812688fc">Load</a>( _guess_orbB ) ) {</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;               <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Do input: failed loading orbitals from &quot;</span>)+_guess_orbB);</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;               </div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;            }</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;            </div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;          <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#aa2fc9390bec8dfae6d3edc283d3d4f5f" title="Guess for a dimer based on monomer orbitals.">Orbitals::PrepareGuess</a>(&amp;_orbitalsA, &amp;_orbitalsB, _orbitalsAB);</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;          </div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;        }</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;          </div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                </div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                </div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                </div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;          _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a68b3dc3980b0f8ed908e6e7005470597" title="writes a coordinate file WITHOUT taking into account PBCs">WriteInputFile</a>( _segments, _orbitalsAB );</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;       }</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;       <span class="keywordflow">if</span> ( _do_dft_run ){</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;          <span class="keywordtype">bool</span> run_success = _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a039f30036f808fe34775fb839848e77f">Run</a>();</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;          <span class="keywordflow">if</span> (!run_success) {</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;             <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;\n GW-BSE without DFT is difficult. Stopping!&quot;</span>));</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;          }</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;          </div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;       }</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;      <span class="comment">// parse DFT data, if required</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;      <span class="keywordflow">if</span> ( _do_dft_parse ){</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot;Parsing DFT data &quot;</span> &lt;&lt; _output_file &lt;&lt; flush;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;       <span class="comment">//int _parse_orbitals_status = _qmpackage-&gt;ParseOrbitalsFile( _orbitals );</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a9b4204018f6c0a5b34796b4d52d51966">setLogFileName</a>( _logfile );</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a91a99035dbf520ae8ddfc05157317148">ParseLogFile</a>( _orbitals );</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#ac857b7c13d1280080ba75ba3644eb083">setOrbitalsFileName</a>( _orbfile );</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        _qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#a1f49903b53d1f5d1b261cc22d39b026d">ParseOrbitalsFile</a>( _orbitals );      <span class="comment">//int _parse_log_status = _qmpackage-&gt;ParseLogFile( _orbitals );</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        _orbitals-&gt;<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#a41b237f5b1d81088ddd1d77fb53bf4cd">setDFTbasis</a>(_qmpackage-&gt;<a class="code" href="classvotca_1_1xtp_1_1QMPackage.html#af0b2ff7bad40b5cc339813a804d96b79">getBasisSetName</a>());</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160; </div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        </div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        </div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        </div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;     }</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;     <span class="comment">// if no parsing of DFT data is requested, reload serialized orbitals object</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;     <span class="keywordflow">if</span> ( !_do_dft_parse ){</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;         <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot;Loading serialized data from &quot;</span> &lt;&lt; _output_file &lt;&lt; flush;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;         _orbitals-&gt;<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#ac8f73a630d462288a5032b0b812688fc">Load</a>( _output_file );</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;     }</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;     <span class="keywordflow">if</span> ( _do_gwbse ){</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;         <a class="code" href="classvotca_1_1xtp_1_1GWBSE.html" title="Electronic excitations from GW-BSE.">GWBSE</a> _gwbse=<a class="code" href="classvotca_1_1xtp_1_1GWBSE.html" title="Electronic excitations from GW-BSE.">GWBSE</a>( _orbitals);</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        _gwbse.<a class="code" href="classvotca_1_1xtp_1_1GWBSE.html#afcf508dfde598659fb41f6338fec01f1">setLogger</a>(&amp;_log);</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        _gwbse.<a class="code" href="classvotca_1_1xtp_1_1GWBSE.html#a90505f1af407ede171586e9bf62d0f1f">Initialize</a>( &amp;_gwbse_options );</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        _gwbse.<a class="code" href="classvotca_1_1xtp_1_1GWBSE.html#a14e5b9661eecd20836279aad86de4e9d">Evaluate</a>();</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        <a class="code" href="classvotca_1_1tools_1_1Property.html" title="class to manage program options with xml serialization functionality">Property</a> *_output_summary = &amp;(_summary.add(<span class="stringliteral">&quot;output&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        _gwbse.<a class="code" href="classvotca_1_1xtp_1_1GWBSE.html#a85d4d651f10e7bcedb32396bfe1dde92">addoutput</a>(_output_summary);</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;       </div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        <span class="comment">//bool _evaluate = _gwbse.Evaluate( _orbitals );</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <span class="comment">// std::cout &lt;&lt; _log;</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;     }</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;     </div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;      </div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    </div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;}</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;</div>
<div class="line"><a name="l01135"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ab6f1466d05cf09626fafb03276807d1d"> 1135</a></span>&#160;<span class="keywordtype">double</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ab6f1466d05cf09626fafb03276807d1d">Exciton::GetTotalEnergy</a>(<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals, <span class="keywordtype">string</span> _spintype, <span class="keywordtype">int</span> _opt_state){</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    </div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="comment">// total energy of the excited state</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <span class="keywordtype">double</span> _total_energy ;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    <span class="keywordtype">double</span> _omega=0.0;</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    </div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="keywordtype">double</span> _dft_energy = _orbitals-&gt;<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#a2dd11222fc5ad8d9091b98f73b7fa65f">getQMEnergy</a>();</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    </div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    <span class="keywordflow">if</span> ( _spintype == <span class="stringliteral">&quot;singlet&quot;</span> ){</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;       _omega      = _orbitals-&gt;<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#a9b9331a15b648a2d5daefd7375b3b3b2">BSESingletEnergies</a>()[_opt_state - 1];</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( _spintype == <span class="stringliteral">&quot;triplet&quot;</span> ){</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        _omega      = _orbitals-&gt;<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#ac319c6576dd9d626a1a9fc136ae6e9fd">BSETripletEnergies</a>()[_opt_state - 1];</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    }</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;GetTotalEnergy only knows spintypes:singlet,triplet&quot;</span>);</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    }</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    </div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    <span class="comment">// DFT total energy is stored in eV</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <span class="comment">// singlet energies are stored in Ryd...</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;  </div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    <span class="keywordflow">return</span> _total_energy = _dft_energy*<a class="code" href="namespacevotca_1_1tools_1_1conv.html#a255353e91f927d7f2fbf0d95817ed4e2">tools::conv::ev2hrt</a> + _omega; <span class="comment">//  e.g. hartree</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    </div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;}</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;</div>
<div class="line"><a name="l01161"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1da9a6a9d4424b304742f3cb45102c63"> 1161</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1da9a6a9d4424b304742f3cb45102c63">Exciton::ReadXYZ</a>(<a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment, <span class="keywordtype">string</span> filename){</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    </div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                <span class="keywordtype">string</span> line;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                std::ifstream in;</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                </div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;           </div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                <span class="keywordtype">string</span> label, type;</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> pos;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                <a class="code" href="logger_8h.html#ad144516788c83f08acfbbe29b2e25de5">CTP_LOG</a>(<a class="code" href="namespacevotca_1_1ctp.html#a6ca95ba08b5f1943b39d7c0d0fad0616a316f858e85e6a70732b82e35ac4e190f">ctp::logDEBUG</a>,_log) &lt;&lt; <span class="stringliteral">&quot; Reading molecular coordinates from &quot;</span> &lt;&lt; _xyzfile &lt;&lt; flush;</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                in.open(_xyzfile.c_str(), std::ios::in);</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                <span class="keywordflow">if</span> (!in) <span class="keywordflow">throw</span> runtime_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Error reading coordinates from: &quot;</span>)</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                        + _xyzfile);</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                </div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                <span class="keywordtype">int</span> atomCount = 1;</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                <span class="keywordflow">if</span> (in.is_open() ) {</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                    <span class="keywordflow">while</span> ( in.good() ) {</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                    <a class="code" href="namespacevotca_1_1tools.html#a7a36b45421bfaa5a38fe45a90f87c3d0" title="Wrapper for a getline function.">std::getline</a>(in, line);</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;                    vector&lt; string &gt; split;</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;                    <a class="code" href="classvotca_1_1tools_1_1Tokenizer.html" title="break string into words">Tokenizer</a> toker(line, <span class="stringliteral">&quot; \t&quot;</span>);</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                    toker.<a class="code" href="classvotca_1_1tools_1_1Tokenizer.html#a344236c051d493ac32ddf310fbad24fe" title="store all words in a vector of strings.">ToVector</a>(split);</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                    <span class="keywordflow">if</span> ( !split.size()      ||</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                          split.size() != 4 ||</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;                          split[0] == <span class="stringliteral">&quot;#&quot;</span>   ||</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;                          split[0].substr(0,1) == <span class="stringliteral">&quot;#&quot;</span> ) { <span class="keywordflow">continue</span>; }</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;            <span class="comment">// Interesting information written here: e.g. &#39;C 0.000 0.000 0.000&#39;</span></div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                        atomCount++;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                        <span class="keywordtype">string</span> element = split[0];</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;                        <span class="keywordtype">double</span> <a class="code" href="namespaceCart.html#a728e7dca1f41916ddf640546ab9f95e9a8fa4feb4dcb48e37dd97e10914465361">x</a> = <a class="code" href="namespacevotca_1_1tools.html#aa8e6d36442ef233cd3f5d59bbd640127">boost::lexical_cast</a>&lt;<span class="keywordtype">double</span>&gt;( split[1] ) / 10.; <span class="comment">//°A to NM</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                        <span class="keywordtype">double</span> <a class="code" href="namespaceCart.html#a728e7dca1f41916ddf640546ab9f95e9ad997094607eb553d530ae1b71492cb77">y</a> = <a class="code" href="namespacevotca_1_1tools.html#aa8e6d36442ef233cd3f5d59bbd640127">boost::lexical_cast</a>&lt;<span class="keywordtype">double</span>&gt;( split[2] ) / 10.;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                        <span class="keywordtype">double</span> <a class="code" href="namespaceCart.html#a728e7dca1f41916ddf640546ab9f95e9af519aabe906d0bae82b4b530be2d3ff8">z</a> = <a class="code" href="namespacevotca_1_1tools.html#aa8e6d36442ef233cd3f5d59bbd640127">boost::lexical_cast</a>&lt;<span class="keywordtype">double</span>&gt;( split[3] ) / 10.;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;                        <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> Pos = <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a>(x,y,z);</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                        <a class="code" href="classvotca_1_1ctp_1_1Atom.html" title="information about an atom">ctp::Atom</a> *pAtom = <span class="keyword">new</span> <a class="code" href="classvotca_1_1ctp_1_1Atom.html" title="information about an atom">ctp::Atom</a>(atomCount, element);</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                        pAtom-&gt;<a class="code" href="classvotca_1_1ctp_1_1Atom.html#ac5128302d7034d92851c934052c0825a">setPos</a>(Pos);</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                        pAtom-&gt;<a class="code" href="classvotca_1_1ctp_1_1Atom.html#af888a363386c5a93530efcfc1234427e">setQMPart</a>(atomCount, Pos);</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;                        pAtom-&gt;<a class="code" href="classvotca_1_1ctp_1_1Atom.html#a6dec530fdf8854d5ceb532aa358896d7">setElement</a>(element);</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                        _segment-&gt;<a class="code" href="classvotca_1_1ctp_1_1Segment.html#a645ed582d1690d24bcba6b8b7de8abea">AddAtom</a>(pAtom);</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    </div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;        }</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    }</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;No such file: &#39;&quot;</span>+filename+<span class="stringliteral">&quot;&#39;.&quot;</span>);</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;    }</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;          </div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;<span class="keywordflow">return</span>;    </div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;}</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div>
<div class="line"><a name="l01212"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a26c92acd001dbd9cd5fa3523c9886e8a"> 1212</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a26c92acd001dbd9cd5fa3523c9886e8a">Exciton::Orbitals2Segment</a>(<a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitals){</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    </div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;            vector&lt; ctp::QMAtom* &gt; _atoms;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;            vector&lt; ctp::QMAtom* &gt; ::iterator ait;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;            _atoms = _orbitals-&gt;<a class="code" href="classvotca_1_1xtp_1_1Orbitals.html#a1299f8aad28c05704b09e0f33d783df0">QMAtoms</a>();</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;            </div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;            <span class="keywordtype">string</span> type;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;            <span class="keywordtype">int</span> <span class="keywordtype">id</span> = 1;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;            <span class="keywordflow">for</span> (ait = _atoms.begin(); ait &lt; _atoms.end(); ++ait) {</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;                </div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;                <span class="comment">// Atom *pAtom = new Atom(id++, type);</span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                </div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                type = (*ait)-&gt;type;</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                <span class="keywordtype">double</span> <a class="code" href="namespaceCart.html#a728e7dca1f41916ddf640546ab9f95e9a8fa4feb4dcb48e37dd97e10914465361">x</a> = (*ait)-&gt;x;</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;                <span class="keywordtype">double</span> <a class="code" href="namespaceCart.html#a728e7dca1f41916ddf640546ab9f95e9ad997094607eb553d530ae1b71492cb77">y</a> = (*ait)-&gt;y;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                <span class="keywordtype">double</span> <a class="code" href="namespaceCart.html#a728e7dca1f41916ddf640546ab9f95e9af519aabe906d0bae82b4b530be2d3ff8">z</a> = (*ait)-&gt;z;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                <a class="code" href="classvotca_1_1ctp_1_1Atom.html" title="information about an atom">ctp::Atom</a> *pAtom = <span class="keyword">new</span> <a class="code" href="classvotca_1_1ctp_1_1Atom.html" title="information about an atom">ctp::Atom</a>(<span class="keywordtype">id</span>++, type);</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                <span class="comment">// cout &lt;&lt; type &lt;&lt; &quot; &quot; &lt;&lt; x &lt;&lt; &quot; &quot; &lt;&lt; y &lt;&lt; &quot; &quot; &lt;&lt; z &lt;&lt; endl;</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a> position(x/10, y/10, z/10); <span class="comment">// xyz has Angstrom, votca stores nm</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                pAtom-&gt;<a class="code" href="classvotca_1_1ctp_1_1Atom.html#ac5128302d7034d92851c934052c0825a">setPos</a>(position);</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;                pAtom-&gt;<a class="code" href="classvotca_1_1ctp_1_1Atom.html#af888a363386c5a93530efcfc1234427e">setQMPart</a>(<span class="keywordtype">id</span>, position);</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;                pAtom-&gt;<a class="code" href="classvotca_1_1ctp_1_1Atom.html#a6dec530fdf8854d5ceb532aa358896d7">setElement</a>(type);</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;                _segment-&gt;<a class="code" href="classvotca_1_1ctp_1_1Segment.html#a645ed582d1690d24bcba6b8b7de8abea">AddAtom</a>(pAtom);</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;            }</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;}</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  </div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  <span class="comment">// write iteration</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae4dd0996ce4b0f818f254f17edee122a"> 1244</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#ae4dd0996ce4b0f818f254f17edee122a">Exciton::WriteIteration</a>(FILE *out, <span class="keywordtype">int</span> _iteration, <a class="code" href="classvotca_1_1ctp_1_1Segment.html">ctp::Segment</a>* _segment, ub::matrix&lt;double&gt;&amp; _force) {</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    vector&lt; ctp::Atom* &gt; ::iterator ait;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    vector&lt; ctp::Atom* &gt; _atoms = _segment-&gt;<a class="code" href="classvotca_1_1ctp_1_1Segment.html#aab099df4198a08de8403c4b6ee38215b">Atoms</a>();</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    <span class="keywordtype">int</span> qmatoms = 0;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="keywordflow">for</span> (ait = _atoms.begin(); ait &lt; _atoms.end(); ++ait) {</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;        ++qmatoms;</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    }</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    fprintf(out, <span class="stringliteral">&quot;%6d \n&quot;</span>, qmatoms);</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    fprintf(out, <span class="stringliteral">&quot;at iteration %d \n&quot;</span>, _iteration);</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    </div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <span class="keywordtype">int</span> _i_atom = 0;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="keywordflow">for</span> (ait = _atoms.begin(); ait &lt; _atoms.end(); ++ait) {</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        <a class="code" href="classvotca_1_1tools_1_1vec.html" title="Vector class for a 3 component vector.">vec</a>     pos = (*ait)-&gt;getQMPos();</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        <span class="keywordtype">string</span>  name = (*ait)-&gt;getElement();</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        fprintf(out, <span class="stringliteral">&quot;%2s %4.7f %4.7f %4.7f atom_vector %4.7f %4.7f %4.7f \n&quot;</span>,</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;                        name.c_str(),</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;                        pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#ab45304f25d8d52b149491a05b1c09a43" title="read only access to x element">getX</a>()*10,</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;                        pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#a272a8c6a3be544a2b9dd4b9f5960b02f" title="read only access to y element">getY</a>()*10,</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;                        pos.<a class="code" href="classvotca_1_1tools_1_1vec.html#acc1ceb986d70006789a06cf60169dea4" title="read only access to z element">getZ</a>()*10,</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                        _force(_i_atom,0)*51.4220822067,</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                        _force(_i_atom,1)*51.4220822067,</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                        _force(_i_atom,2)*51.4220822067);</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;        _i_atom++;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    }</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;}</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;  </div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  </div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;  </div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;  </div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  </div>
<div class="line"><a name="l01281"></a><span class="lineno"><a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1760a4e745a07f078bf783284a1edcf3"> 1281</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classvotca_1_1xtp_1_1Exciton.html#a1760a4e745a07f078bf783284a1edcf3">Exciton::PrepareGuess</a>( <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitalsA, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitalsB, <a class="code" href="classvotca_1_1xtp_1_1Orbitals.html" title="container for molecular orbitals">Orbitals</a>* _orbitalsAB ) {</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;  </div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;}   </div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  </div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;  </div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;  </div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  </div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;}}</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;<span class="preprocessor">#endif</span></div>
</div><!-- fragment --></div><!-- contents -->
